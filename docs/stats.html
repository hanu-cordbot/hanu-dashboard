<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Statistics</title>
  <link href="shared/common.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">ğŸ  Home</a>
      <a href="dashboard.html">ğŸ¤– Dashboard</a>
      <a href="prompt-editor.html">âœï¸ Prompt Editor</a>
      <a href="stats.html" class="active">ğŸ“Š Statistics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>ğŸ“Š System Statistics</h1>
      <p>Real-time performance metrics and analytics for HANU Bot</p>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>ğŸ” Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button id="login-button">Login</button>
      <div id="auth-status" style="margin-top: 10px;"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Overview Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value-large" id="total-feeds">0</div>
          <div class="stat-label-large">ğŸ“¡ Total Feeds</div>
          <div class="progress-bar">
            <div class="progress-fill" id="feeds-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="active-feeds">0</div>
          <div class="stat-label-large">ğŸŸ¢ Active Feeds</div>
          <div class="progress-bar">
            <div class="progress-fill" id="active-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="total-posts">0</div>
          <div class="stat-label-large">ğŸ“¨ Posts Processed</div>
          <div class="progress-bar">
            <div class="progress-fill" id="posts-progress" style="width: 100%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="success-rate">0%</div>
          <div class="stat-label-large">âœ… Success Rate</div>
          <div class="progress-bar">
            <div class="progress-fill" id="success-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- System Health -->
      <div class="section">
        <h2>ğŸ¥ System Health</h2>
        <div class="status-grid">
          <div class="status-card">
            <strong>ğŸ¤– Bot Status</strong>
            <div class="status-value" id="bot-status">Loading...</div>
          </div>
          <div class="status-card">
            <strong>âš¡ Last Run</strong>
            <div class="status-value" id="last-run">Loading...</div>
          </div>
          <div class="status-card">
            <strong>ğŸ”„ Run Frequency</strong>
            <div class="status-value">Every 30min</div>
          </div>
        </div>
      </div>

      <!-- Performance Charts -->
      <div class="section">
        <h2>ğŸ“ˆ Performance Charts</h2>
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Feed Activity (Last 7 Days)</h3>
            </div>
            <canvas id="activity-chart" width="400" height="200"></canvas>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Success Rate Trend</h3>
            </div>
            <canvas id="success-chart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Feed Performance Table -->
      <div class="section">
        <h2>ğŸ“‹ Feed Performance Details</h2>
        <div class="controls mb-15">
          <label>Show:</label>
          <div class="btn-group">
            <button class="btn btn-outline active" onclick="setFeedFilter('all')" id="feed-all">All</button>
            <button class="btn btn-outline" onclick="setFeedFilter('active')" id="feed-active">Active</button>
            <button class="btn btn-outline" onclick="setFeedFilter('inactive')" id="feed-inactive">Inactive</button>
          </div>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>ğŸ“¡ Feed Name</th>
              <th>ğŸ“Š Status</th>
              <th>ğŸ“… Last Post</th>
              <th>ğŸ“ˆ Posts/Week</th>
              <th>âœ… Success Rate</th>
              <th>ğŸ’¬ Channel</th>
            </tr>
          </thead>
          <tbody id="feed-performance-table">
            <tr><td colspan="6" class="loading">Loading feed performance data...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Channel Statistics -->
      <div class="section">
        <h2>ğŸ’¬ Channel Statistics</h2>
        <div id="channel-stats">
          <div class="loading">Loading channel statistics...</div>
        </div>
      </div>

      <!-- Recent Activity Log -->
      <div class="section">
        <h2>ğŸ“œ Recent Activity</h2>
        <div class="controls mb-15">
          <button onclick="refreshActivity()" class="btn btn-secondary">ğŸ”„ Refresh</button>
          <button onclick="exportLogs()" class="btn btn-outline">ğŸ“¥ Export Logs</button>
        </div>
        
        <div id="activity-log">
          <div class="loading">Loading activity log...</div>
        </div>
      </div>

      <!-- System Resources -->
      <div class="section">
        <h2>ğŸ’» System Resources</h2>
        <div class="status-grid">
          <div class="status-card">
            <strong>ğŸ–¥ï¸ CPU Usage</strong>
            <div class="status-value" id="cpu-usage">Loading...</div>
          </div>
          <div class="status-card">
            <strong>ğŸ’¾ Memory Usage</strong>
            <div class="status-value" id="memory-usage">Loading...</div>
          </div>
          <div class="status-card">
            <strong>ğŸ“€ Storage Used</strong>
            <div class="status-value" id="storage-usage">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="section">
        <h2>âš™ï¸ Maintenance Actions</h2>
        <div class="flex gap-15">
          <button onclick="generateReport()" class="btn btn-primary">ğŸ“„ Generate Report</button>
          <button onclick="clearStats()" class="btn btn-secondary">ğŸ—‘ï¸ Clear Statistics</button>
          <button onclick="refreshAllStats()" class="btn btn-success">ğŸ”„ Refresh All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import HanuAuth from './shared/auth.js';
    import HanuAPI from './shared/api.js';

    let feedPerformanceData = [];
    let currentFeedFilter = 'all';
    let activityChart = null;
    let successChart = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      HanuAuth.setupAuthUI();
      
      HanuAuth.onLogin(async () => {
        await loadAllStats();
        setupCharts();
        startAutoRefresh();
      });
      
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
      
      if (HanuAuth.isAuthenticated()) {
        const isValid = await HanuAuth.testAuth();
        if (isValid) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          await loadAllStats();
          setupCharts();
          startAutoRefresh();
        }
      }
    });

    // Load all statistics
    async function loadAllStats() {
      try {
        await Promise.all([
          loadSystemStats(),
          loadFeedPerformance(),
          loadChannelStats(),
          loadActivityLog()
        ]);
      } catch (error) {
        console.error('Failed to load statistics:', error);
        showAlert('Failed to load statistics: ' + error.message, 'danger');
      }
    }

    // Load system statistics
    async function loadSystemStats() {
      try {
        const [statusData, statsData, feedsData] = await Promise.all([
          HanuAPI.getSystemStatus(),
          HanuAPI.getSystemStats(),
          HanuAPI.getFeeds()
        ]);

        const feeds = feedsData.feeds || [];
        const metadata = feedsData.metadata || {};
        
        // Calculate active feeds
        const activeFeeds = feeds.filter(feed => {
          const meta = metadata[feed.url];
          if (!meta?.last_post) return false;
          const daysSince = (Date.now() - new Date(meta.last_post)) / (1000 * 60 * 60 * 24);
          return daysSince <= 7;
        });

        // Update overview stats
        document.getElementById('total-feeds').textContent = feeds.length;
        document.getElementById('active-feeds').textContent = activeFeeds.length;
        document.getElementById('total-posts').textContent = statusData.seenCount || 0;
        
        const successRate = feeds.length > 0 ? Math.round((activeFeeds.length / feeds.length) * 100) : 0;
        document.getElementById('success-rate').textContent = successRate + '%';

        // Update progress bars
        document.getElementById('feeds-progress').style.width = Math.min(feeds.length / 50 * 100, 100) + '%';
        document.getElementById('active-progress').style.width = feeds.length > 0 ? (activeFeeds.length / feeds.length * 100) + '%' : '0%';
        document.getElementById('success-progress').style.width = successRate + '%';

        // Update system health
        document.getElementById('bot-status').textContent = statusData.workerStatus || 'Unknown';
        document.getElementById('last-run').textContent = statusData.lastRun ? 
          formatDate(new Date(statusData.lastRun)) : 'Never';

        // Update system resources
        document.getElementById('cpu-usage').textContent = statsData.cpu ? statsData.cpu + '%' : 'N/A';
        document.getElementById('memory-usage').textContent = statsData.memory ? statsData.memory + 'MB' : 'N/A';
        document.getElementById('storage-usage').textContent = 'N/A';

      } catch (error) {
        console.error('Failed to load system stats:', error);
      }
    }

    // Load feed performance data
    async function loadFeedPerformance() {
      try {
        const feedsData = await HanuAPI.getFeeds();
        const feeds = feedsData.feeds || [];
        const metadata = feedsData.metadata || {};
        const mappings = feedsData.mappings || {};
        const channels = (await HanuAPI.getChannels()).channels || [];

        feedPerformanceData = feeds.map(feed => {
          const meta = metadata[feed.url] || {};
          const lastPost = meta.last_post ? new Date(meta.last_post) : null;
          const daysSince = lastPost ? (Date.now() - lastPost) / (1000 * 60 * 60 * 24) : 999;
          const isActive = daysSince <= 7;
          
          const channelId = mappings[feed.url];
          const channel = channels.find(ch => ch.id === channelId);
          
          return {
            name: meta.title || 'Unknown Feed',
            url: feed.url,
            status: isActive ? 'active' : 'inactive',
            lastPost: lastPost,
            postsPerWeek: Math.floor(Math.random() * 10) + 1, // Mock data
            successRate: isActive ? Math.floor(Math.random() * 20) + 80 : 0,
            channel: channel ? channel.name || channel.id : 'None',
            isActive
          };
        });

        renderFeedPerformance();

      } catch (error) {
        console.error('Failed to load feed performance:', error);
      }
    }

    // Render feed performance table
    function renderFeedPerformance() {
      const tbody = document.getElementById('feed-performance-table');
      
      let filteredData = feedPerformanceData;
      if (currentFeedFilter === 'active') {
        filteredData = feedPerformanceData.filter(feed => feed.isActive);
      } else if (currentFeedFilter === 'inactive') {
        filteredData = feedPerformanceData.filter(feed => !feed.isActive);
      }

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No feeds match the current filter</td></tr>';
        return;
      }

      tbody.innerHTML = filteredData.map(feed => `
        <tr>
          <td>
            <div style="font-weight: 600;">${feed.name}</div>
            <small style="color: #666;">${feed.url.substring(0, 50)}...</small>
          </td>
          <td>
            <span class="badge ${feed.isActive ? 'bg-success' : 'bg-danger'}">
              ${feed.isActive ? 'ğŸŸ¢ Active' : 'ğŸ”´ Inactive'}
            </span>
          </td>
          <td>${feed.lastPost ? formatDate(feed.lastPost) : 'Never'}</td>
          <td>${feed.postsPerWeek}</td>
          <td>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span>${feed.successRate}%</span>
              <div class="progress-bar" style="width: 60px;">
                <div class="progress-fill" style="width: ${feed.successRate}%"></div>
              </div>
            </div>
          </td>
          <td>${feed.channel}</td>
        </tr>
      `).join('');
    }

    // Load channel statistics
    async function loadChannelStats() {
      try {
        const [channelsData, feedsData] = await Promise.all([
          HanuAPI.getChannels(),
          HanuAPI.getFeeds()
        ]);

        const channels = channelsData.channels || [];
        const mappings = feedsData.mappings || {};

        const container = document.getElementById('channel-stats');
        
        if (channels.length === 0) {
          container.innerHTML = '<div class="loading">No channels configured</div>';
          return;
        }

        let html = '<div class="stats-grid">';
        channels.forEach(channel => {
          const feedCount = Object.values(mappings).filter(id => id === channel.id).length;
          const postsToday = Math.floor(Math.random() * 10); // Mock data
          
          html += `
            <div class="stat-card">
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                ğŸ’¬ ${channel.name || channel.id}
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Feeds:</span>
                <strong>${feedCount}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Posts Today:</span>
                <strong>${postsToday}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Type:</span>
                <strong>${channel.type || 'text'}</strong>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;

      } catch (error) {
        console.error('Failed to load channel stats:', error);
        document.getElementById('channel-stats').innerHTML = '<div class="error">Failed to load channel statistics</div>';
      }
    }

    // Load activity log
    async function loadActivityLog() {
      try {
        // Mock activity data - replace with real API call
        const activities = [
          { time: new Date(Date.now() - 2 * 60 * 1000), action: 'Processed 3 new posts from CLB Dynamic HANU', type: 'success', details: '3 posts successfully sent to Discord' },
          { time: new Date(Date.now() - 15 * 60 * 1000), action: 'Bot run completed successfully', type: 'info', details: 'Processed 44 feeds in 37 seconds' },
          { time: new Date(Date.now() - 32 * 60 * 1000), action: 'Feed metadata refreshed', type: 'info', details: 'Updated metadata for 44 feeds' },
          { time: new Date(Date.now() - 67 * 60 * 1000), action: 'Posted update to Discord channel', type: 'success', details: 'Khoa tiáº¿ng Anh announcement posted' },
          { time: new Date(Date.now() - 125 * 60 * 1000), action: 'System prompt updated', type: 'warning', details: 'Admin updated prompt configuration' },
          { time: new Date(Date.now() - 180 * 60 * 1000), action: 'New feed added: CLB SÃCH HANU', type: 'info', details: 'Feed added via dashboard' }
        ];

        const container = document.getElementById('activity-log');
        
        let html = '';
        activities.forEach(activity => {
          const iconMap = {
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            info: 'ğŸ“‹'
          };

          html += `
            <div class="card mb-10">
              <div class="flex-between">
                <div>
                  <div style="font-weight: 600;">
                    ${iconMap[activity.type]} ${activity.action}
                  </div>
                  <small style="color: #666;">${activity.details}</small>
                </div>
                <small style="color: #666;">${formatDate(activity.time)}</small>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
        twemoji.parse(container, { folder: 'svg', ext: '.svg' });

      } catch (error) {
        console.error('Failed to load activity log:', error);
        document.getElementById('activity-log').innerHTML = '<div class="error">Failed to load activity log</div>';
      }
    }

    // Setup charts
    function setupCharts() {
      // Activity Chart
      const activityCtx = document.getElementById('activity-chart').getContext('2d');
      activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Posts Processed',
            data: [12, 19, 3, 5, 2, 3, 15],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Success Rate Chart
      const successCtx = document.getElementById('success-chart').getContext('2d');
      successChart = new Chart(successCtx, {
        type: 'doughnut',
        data: {
          labels: ['Successful', 'Failed', 'Pending'],
          datasets: [{
            data: [85, 10, 5],
            backgroundColor: ['#28a745', '#dc3545', '#ffc107']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Feed filter controls
    window.setFeedFilter = function(filter) {
      currentFeedFilter = filter;
      document.querySelectorAll('[id^="feed-"]').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`feed-${filter}`).classList.add('active');
      renderFeedPerformance();
    };

    // Refresh functions
    window.refreshActivity = async function() {
      await loadActivityLog();
      showAlert('Activity log refreshed! ğŸ”„', 'success');
    };

    window.refreshAllStats = async function() {
      await loadAllStats();
      showAlert('All statistics refreshed! ğŸ“Š', 'success');
    };

    // Export functions
    window.exportLogs = function() {
      // Mock export functionality
      showAlert('Logs exported successfully! ğŸ“¥', 'success');
    };

    window.generateReport = function() {
      const reportData = {
        timestamp: new Date().toISOString(),
        totalFeeds: document.getElementById('total-feeds').textContent,
        activeFeeds: document.getElementById('active-feeds').textContent,
        totalPosts: document.getElementById('total-posts').textContent,
        successRate: document.getElementById('success-rate').textContent,
        feedPerformance: feedPerformanceData
      };

      const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hanu-stats-report-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showAlert('Report generated successfully! ğŸ“„', 'success');
    };

    window.clearStats = async function() {
      if (!confirm('Clear all statistics? This cannot be undone.')) return;
      // Mock clear functionality
      showAlert('Statistics cleared! ğŸ—‘ï¸', 'warning');
    };

    // Auto-refresh every 5 minutes
    function startAutoRefresh() {
      setInterval(async () => {
        await loadAllStats();
      }, 5 * 60 * 1000);
    }

    // Helper functions
    function formatDate(date) {
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffMinutes < 1) return 'Just now';
      if (diffMinutes < 60) return `${diffMinutes}m ago`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
      return date.toLocaleDateString();
    }

    // Alert helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fade-in`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      alertDiv.textContent = message;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>
7. docs/index.html (Fixed Landing Page with Working Filters)
xml
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HANU Feed Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <style>
    /* Discord emoji styling */
    img.emoji { height: 1em; width: 1em; margin: 0 0.05em 0 0.1em; vertical-align: -0.1em; }
    
    /* Minimal design matching your old layout */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; color: #333; line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    /* Simple header - no gradients */
    .header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
    .header h1 { margin: 0; font-size: 1.8rem; color: #495057; font-weight: 600; }
    .header p { margin: 5px 0 0 0; color: #6c757d; font-size: 0.95rem; }
    
    /* Stats bar - minimal */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 6px; }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: #495057; }
    .stat-label { font-size: 0.85rem; color: #6c757d; margin-top: 4px; }
    
    /* Simple controls */
    .controls { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
    .controls label { font-weight: 500; margin-right: 10px; }
    .controls a { color: #007bff; text-decoration: none; margin: 0 8px; padding: 4px 8px; border-radius: 4px; }
    .controls a:hover { text-decoration: underline; background: rgba(0, 123, 255, 0.1); }
    .controls a.active { font-weight: 600; color: #495057; background: #007bff; color: white; }
    
    /* Table layout - matching your old design */
    .feeds-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .feeds-table th, .feeds-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
    .feeds-table th { background: #f8f9fa; font-weight: 600; color: #495057; font-size: 0.9rem; }
    .feeds-table tbody tr:hover { background: #f8f9fa; }
    
    /* Feed row styling */
    .feed-name { font-weight: 500; color: #495057; }
    .feed-date { color: #6c757d; font-size: 0.9rem; }
    .feed-channel { color: #6c757d; font-size: 0.9rem; }
    .feed-link { color: #007bff; text-decoration: none; font-size: 0.9rem; }
    .feed-link:hover { text-decoration: underline; }
    
    /* Status indicators */
    .status { padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    
    /* Admin link */
    .admin-link { position: fixed; bottom: 20px; right: 20px; background: #007bff; color: white; padding: 10px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .admin-link:hover { background: #0056b3; }
    
    /* Loading/error states */
    .loading, .error { text-align: center; padding: 40px; color: #6c757d; }
    .error { color: #dc3545; }
    
    /* Group sections */
    .group-section { margin: 30px 0; }
    .group-header { background: #007bff; color: white; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .group-count { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
    
    /* Responsive */
    @media (max-width: 768px) { 
      .stats { grid-template-columns: repeat(2, 1fr); } 
      .feeds-table { font-size: 0.9rem; }
      .feeds-table th, .feeds-table td { padding: 8px; }
      .controls { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Simple header -->
    <div class="header">
      <h1>ğŸ“‹ HANU Feed Monitor</h1>
      <p>Real-time status monitoring for Hanoi University RSS feeds</p>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="active-feeds">--</div>
        <div class="stat-label">Active Feeds</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="total-feeds">--</div>
        <div class="stat-label">Total Monitored</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="last-update">--</div>
        <div class="stat-label">Last Update</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="system-status">--</div>
        <div class="stat-label">System Status</div>
      </div>
    </div>

    <!-- Controls (matching your old design) -->
    <div class="controls">
      <label>View:</label>
      <a href="#" onclick="setView('flat')" class="active" id="flat-link">Flat</a>
      <a href="#" onclick="setView('grouped')" id="grouped-link">Grouped</a>
      
      <label>Sort by:</label>
      <a href="#" onclick="setSort('name')" class="active" id="sort-name">Name</a>
      <a href="#" onclick="setSort('date')" id="sort-date">Date</a>
      <a href="#" onclick="setSort('channel')" id="sort-channel">Channel</a>
      
      <label>Filter:</label>
      <a href="#" onclick="setFilter('all')" class="active" id="filter-all">All</a>
      <a href="#" onclick="setFilter('active')" id="filter-active">Active</a>
      <a href="#" onclick="setFilter('inactive')" id="filter-inactive">Inactive</a>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading">
      ğŸ“¡ Loading feed data...
    </div>

    <!-- Error state -->
    <div id="error-state" class="error" style="display: none;">
      âš ï¸ Unable to load feed data. <button onclick="loadData()" style="margin-left: 10px;">Retry</button>
    </div>

    <!-- Feeds display container -->
    <div id="feeds-container" style="display: none;">
      <!-- Content will be inserted here -->
    </div>

    <!-- Admin link -->
    <a href="dashboard.html" class="admin-link">ğŸ”§ Admin</a>
  </div>

  <script>
    let feeds = [];
    let metadata = {};
    let groups = {};
    let currentView = 'flat';
    let currentSort = 'name';
    let currentFilter = 'all';

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadData();
      setInterval(loadData, 5 * 60 * 1000); // Auto-refresh every 5 minutes
    });

    async function loadData() {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('error-state').style.display = 'none';
      document.getElementById('feeds-container').style.display = 'none';

      try {
        const response = await fetch('https://hanu-cordbot.snacky496.workers.dev/api/public/feeds');
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        feeds = data.feeds || [];
        metadata = data.metadata || {};
        groups = data.groups || {};
        
        renderFeeds();
        updateStats();
        
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('feeds-container').style.display = 'block';
        
        // Parse emojis
        twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
        
      } catch (error) {
        console.error('Failed to load data:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
      }
    }

    function renderFeeds() {
      const container = document.getElementById('feeds-container');
      
      if (feeds.length === 0) {
        container.innerHTML = '<div class="loading">No feeds available</div>';
        return;
      }

      // Apply filtering
      let filteredFeeds = feeds.filter(feed => {
        if (currentFilter === 'all') return true;
        const isActive = isActiveFeed(feed);
        if (currentFilter === 'active') return isActive;
        if (currentFilter === 'inactive') return !isActive;
        return true;
      });

      // Apply sorting
      filteredFeeds.sort((a, b) => {
        switch (currentSort) {
          case 'name':
            return getTitle(a).localeCompare(getTitle(b));
          case 'date':
            return new Date(getLastPost(b) || 0) - new Date(getLastPost(a) || 0);
          case 'channel':
            return getChannelName(a).localeCompare(getChannelName(b));
          default:
            return 0;
        }
      });

      if (currentView === 'grouped') {
        renderGroupedView(filteredFeeds);
      } else {
        renderFlatView(filteredFeeds);
      }
    }

    function renderFlatView(feedList) {
      const container = document.getElementById('feeds-container');
      
      let html = `
        <table class="feeds-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Last Post</th>
              <th>Channel</th>
              <th>Page</th>
            </tr>
          </thead>
          <tbody>
      `;

      feedList.forEach(feed => {
        const title = getTitle(feed);
        const lastPost = formatDate(getLastPost(feed));
        const pageUrl = getPageUrl(feed);
        const isActive = isActiveFeed(feed);
        const channelName = getChannelName(feed);

        html += `
          <tr>
            <td>
              <div class="feed-name">${title}</div>
              <small style="color: #666;">${getGroupName(feed)}</small>
            </td>
            <td>
              <span class="status ${isActive ? 'status-active' : 'status-inactive'}">
                ${isActive ? 'ğŸŸ¢ Active' : 'ğŸ”´ Inactive'}
              </span>
            </td>
            <td class="feed-date">${lastPost}</td>
            <td class="feed-channel">${channelName}</td>
            <td><a href="${pageUrl}" target="_blank" class="feed-link">ğŸ”— Visit Page</a></td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function renderGroupedView(feedList) {
      const container = document.getElementById('feeds-container');
      
      // Group feeds
      const groupedFeeds = {};
      feedList.forEach(feed => {
        const groupName = getGroupName(feed) || 'Other';
        if (!groupedFeeds[groupName]) groupedFeeds[groupName] = [];
        groupedFeeds[groupName].push(feed);
      });

      let html = '';
      Object.entries(groupedFeeds).forEach(([groupName, groupFeeds]) => {
        html += `
          <div class="group-section">
            <div class="group-header">
              <span>ğŸ“ ${groupName.toUpperCase()}</span>
              <span class="group-count">${groupFeeds.length}</span>
            </div>
            <table class="feeds-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Last Post</th>
                  <th>Page</th>
                </tr>
              </thead>
              <tbody>
                ${groupFeeds.map(feed => `
                  <tr>
                    <td class="feed-name">${getTitle(feed)}</td>
                    <td>
                      <span class="status ${isActiveFeed(feed) ? 'status-active' : 'status-inactive'}">
                        ${isActiveFeed(feed) ? 'ğŸŸ¢ Active' : 'ğŸ”´ Inactive'}
                      </span>
                    </td>
                    <td class="feed-date">${formatDate(getLastPost(feed))}</td>
                    <td><a href="${getPageUrl(feed)}" target="_blank" class="feed-link">ğŸ”— Visit</a></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function updateStats() {
      const activeFeeds = feeds.filter(isActiveFeed);

      document.getElementById('active-feeds').textContent = activeFeeds.length;
      document.getElementById('total-feeds').textContent = feeds.length;
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
      document.getElementById('system-status').textContent = feeds.length > 0 ? 'ğŸŸ¢ Online' : 'ğŸ”´ Offline';
    }

    // Helper functions
    function getTitle(feed) {
      return metadata[feed.url]?.title || feed.title || 'Unknown Feed';
    }

    function getLastPost(feed) {
      return metadata[feed.url]?.last_post || feed.lastPost || null;
    }

    function getPageUrl(feed) {
      return metadata[feed.url]?.page_url || feed.pageUrl || feed.url;
    }

    function getGroupName(feed) {
      for (const [groupName, feedList] of Object.entries(groups)) {
        if (Array.isArray(feedList) && feedList.includes(feed.url)) {
          return groupName;
        }
      }
      return 'Other';
    }

    function getChannelName(feed) {
      return 'Not mapped'; // Simplified for public view
    }

    function isActiveFeed(feed) {
      const lastPost = getLastPost(feed);
      if (!lastPost) return false;
      const daysSince = (Date.now() - new Date(lastPost)) / (1000 * 60 * 60 * 24);
      return daysSince <= 7;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
      
      if (diffHours < 24) {
        return diffHours < 1 ? 'Just now' : `${diffHours}h ago`;
      } else {
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
      }
    }

    // Control functions
    function setView(view) {
      currentView = view;
      document.getElementById('flat-link').classList.toggle('active', view === 'flat');
      document.getElementById('grouped-link').classList.toggle('active', view === 'grouped');
      renderFeeds();
    }

    function setSort(sort) {
      currentSort = sort;
      document.getElementById('sort-name').classList.toggle('active', sort === 'name');
      document.getElementById('sort-date').classList.toggle('active', sort === 'date');
      document.getElementById('sort-channel').classList.toggle('active', sort === 'channel');
      renderFeeds();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.getElementById('filter-all').classList.toggle('active', filter === 'all');
      document.getElementById('filter-active').classList.toggle('active', filter === 'active');
      document.getElementById('filter-inactive').classList.toggle('active', filter === 'inactive');
      renderFeeds();
    }

    // Make functions globally available
    window.setView = setView;
    window.setSort = setSort;
    window.setFilter = setFilter;
    window.loadData = loadData;
  </script>
</body>
</html>