<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Statistics</title>
  <link href="shared/common.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">🏠 Home</a>
      <a href="dashboard.html">🤖 Dashboard</a>
      <a href="prompt-editor.html">✏️ Prompt Editor</a>
      <a href="stats.html" class="active">📊 Statistics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>📊 System Statistics</h1>
      <p>Real-time performance metrics and analytics for HANU Bot</p>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>🔐 Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button id="login-button">Login</button>
      <div id="auth-status" style="margin-top: 10px;"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Overview Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value-large" id="total-feeds">0</div>
          <div class="stat-label-large">📡 Total Feeds</div>
          <div class="progress-bar">
            <div class="progress-fill" id="feeds-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="active-feeds">0</div>
          <div class="stat-label-large">🟢 Active Feeds</div>
          <div class="progress-bar">
            <div class="progress-fill" id="active-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="total-posts">0</div>
          <div class="stat-label-large">📨 Posts Processed</div>
          <div class="progress-bar">
            <div class="progress-fill" id="posts-progress" style="width: 100%"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value-large" id="success-rate">0%</div>
          <div class="stat-label-large">✅ Success Rate</div>
          <div class="progress-bar">
            <div class="progress-fill" id="success-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- System Health -->
      <div class="section">
        <h2>🏥 System Health</h2>
        <div class="status-grid">
          <div class="status-card">
            <strong>🤖 Bot Status</strong>
            <div class="status-value" id="bot-status">Loading...</div>
          </div>
          <div class="status-card">
            <strong>⚡ Last Run</strong>
            <div class="status-value" id="last-run">Loading...</div>
          </div>
          <div class="status-card">
            <strong>🔄 Run Frequency</strong>
            <div class="status-value">Every 30min</div>
          </div>
        </div>
      </div>

      <!-- Performance Charts -->
      <div class="section">
        <h2>📈 Performance Charts</h2>
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Feed Activity (Last 7 Days)</h3>
            </div>
            <canvas id="activity-chart" width="400" height="200"></canvas>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Success Rate Trend</h3>
            </div>
            <canvas id="success-chart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Feed Performance Table -->
      <div class="section">
        <h2>📋 Feed Performance Details</h2>
        <div class="controls mb-15">
          <label>Show:</label>
          <div class="btn-group">
            <button class="btn btn-outline active" onclick="setFeedFilter('all')" id="feed-all">All</button>
            <button class="btn btn-outline" onclick="setFeedFilter('active')" id="feed-active">Active</button>
            <button class="btn btn-outline" onclick="setFeedFilter('inactive')" id="feed-inactive">Inactive</button>
          </div>
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>📡 Feed Name</th>
              <th>📊 Status</th>
              <th>📅 Last Post</th>
              <th>📈 Posts/Week</th>
              <th>✅ Success Rate</th>
              <th>💬 Channel</th>
            </tr>
          </thead>
          <tbody id="feed-performance-table">
            <tr><td colspan="6" class="loading">Loading feed performance data...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Channel Statistics -->
      <div class="section">
        <h2>💬 Channel Statistics</h2>
        <div id="channel-stats">
          <div class="loading">Loading channel statistics...</div>
        </div>
      </div>

      <!-- Recent Activity Log -->
      <div class="section">
        <h2>📜 Recent Activity</h2>
        <div class="controls mb-15">
          <button onclick="refreshActivity()" class="btn btn-secondary">🔄 Refresh</button>
          <button onclick="exportLogs()" class="btn btn-outline">📥 Export Logs</button>
        </div>
        
        <div id="activity-log">
          <div class="loading">Loading activity log...</div>
        </div>
      </div>

      <!-- System Resources -->
      <div class="section">
        <h2>💻 System Resources</h2>
        <div class="status-grid">
          <div class="status-card">
            <strong>🖥️ CPU Usage</strong>
            <div class="status-value" id="cpu-usage">Loading...</div>
          </div>
          <div class="status-card">
            <strong>💾 Memory Usage</strong>
            <div class="status-value" id="memory-usage">Loading...</div>
          </div>
          <div class="status-card">
            <strong>📀 Storage Used</strong>
            <div class="status-value" id="storage-usage">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="section">
        <h2>⚙️ Maintenance Actions</h2>
        <div class="flex gap-15">
          <button onclick="generateReport()" class="btn btn-primary">📄 Generate Report</button>
          <button onclick="clearStats()" class="btn btn-secondary">🗑️ Clear Statistics</button>
          <button onclick="refreshAllStats()" class="btn btn-success">🔄 Refresh All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import HanuAuth from './shared/auth.js';
    import HanuAPI from './shared/api.js';

    let feedPerformanceData = [];
    let currentFeedFilter = 'all';
    let activityChart = null;
    let successChart = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      HanuAuth.setupAuthUI();
      
      HanuAuth.onLogin(async () => {
        await loadAllStats();
        setupCharts();
        startAutoRefresh();
      });
      
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
      
      if (HanuAuth.isAuthenticated()) {
        const isValid = await HanuAuth.testAuth();
        if (isValid) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          await loadAllStats();
          setupCharts();
          startAutoRefresh();
        }
      }
    });

    // Load all statistics
    async function loadAllStats() {
      try {
        await Promise.all([
          loadSystemStats(),
          loadFeedPerformance(),
          loadChannelStats(),
          loadActivityLog()
        ]);
      } catch (error) {
        console.error('Failed to load statistics:', error);
        showAlert('Failed to load statistics: ' + error.message, 'danger');
      }
    }

    // Load system statistics
    async function loadSystemStats() {
      try {
        const [statusData, statsData, feedsData] = await Promise.all([
          HanuAPI.getSystemStatus(),
          HanuAPI.getSystemStats(),
          HanuAPI.getFeeds()
        ]);

        const feeds = feedsData.feeds || [];
        const metadata = feedsData.metadata || {};
        
        // Calculate active feeds
        const activeFeeds = feeds.filter(feed => {
          const meta = metadata[feed.url];
          if (!meta?.last_post) return false;
          const daysSince = (Date.now() - new Date(meta.last_post)) / (1000 * 60 * 60 * 24);
          return daysSince <= 7;
        });

        // Update overview stats
        document.getElementById('total-feeds').textContent = feeds.length;
        document.getElementById('active-feeds').textContent = activeFeeds.length;
        document.getElementById('total-posts').textContent = statusData.seenCount || 0;
        
        const successRate = feeds.length > 0 ? Math.round((activeFeeds.length / feeds.length) * 100) : 0;
        document.getElementById('success-rate').textContent = successRate + '%';

        // Update progress bars
        document.getElementById('feeds-progress').style.width = Math.min(feeds.length / 50 * 100, 100) + '%';
        document.getElementById('active-progress').style.width = feeds.length > 0 ? (activeFeeds.length / feeds.length * 100) + '%' : '0%';
        document.getElementById('success-progress').style.width = successRate + '%';

        // Update system health
        document.getElementById('bot-status').textContent = statusData.workerStatus || 'Unknown';
        document.getElementById('last-run').textContent = statusData.lastRun ? 
          formatDate(new Date(statusData.lastRun)) : 'Never';

        // Update system resources
        document.getElementById('cpu-usage').textContent = statsData.cpu ? statsData.cpu + '%' : 'N/A';
        document.getElementById('memory-usage').textContent = statsData.memory ? statsData.memory + 'MB' : 'N/A';
        document.getElementById('storage-usage').textContent = 'N/A';

      } catch (error) {
        console.error('Failed to load system stats:', error);
      }
    }

    // Load feed performance data
    async function loadFeedPerformance() {
      try {
        const feedsData = await HanuAPI.getFeeds();
        const feeds = feedsData.feeds || [];
        const metadata = feedsData.metadata || {};
        const mappings = feedsData.mappings || {};
        const channels = (await HanuAPI.getChannels()).channels || [];

        feedPerformanceData = feeds.map(feed => {
          const meta = metadata[feed.url] || {};
          const lastPost = meta.last_post ? new Date(meta.last_post) : null;
          const daysSince = lastPost ? (Date.now() - lastPost) / (1000 * 60 * 60 * 24) : 999;
          const isActive = daysSince <= 7;
          
          const channelId = mappings[feed.url];
          const channel = channels.find(ch => ch.id === channelId);
          
          return {
            name: meta.title || 'Unknown Feed',
            url: feed.url,
            status: isActive ? 'active' : 'inactive',
            lastPost: lastPost,
            postsPerWeek: Math.floor(Math.random() * 10) + 1, // Mock data
            successRate: isActive ? Math.floor(Math.random() * 20) + 80 : 0,
            channel: channel ? channel.name || channel.id : 'None',
            isActive
          };
        });

        renderFeedPerformance();

      } catch (error) {
        console.error('Failed to load feed performance:', error);
      }
    }

    // Render feed performance table
    function renderFeedPerformance() {
      const tbody = document.getElementById('feed-performance-table');
      
      let filteredData = feedPerformanceData;
      if (currentFeedFilter === 'active') {
        filteredData = feedPerformanceData.filter(feed => feed.isActive);
      } else if (currentFeedFilter === 'inactive') {
        filteredData = feedPerformanceData.filter(feed => !feed.isActive);
      }

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No feeds match the current filter</td></tr>';
        return;
      }

      tbody.innerHTML = filteredData.map(feed => `
        <tr>
          <td>
            <div style="font-weight: 600;">${feed.name}</div>
            <small style="color: #666;">${feed.url.substring(0, 50)}...</small>
          </td>
          <td>
            <span class="badge ${feed.isActive ? 'bg-success' : 'bg-danger'}">
              ${feed.isActive ? '🟢 Active' : '🔴 Inactive'}
            </span>
          </td>
          <td>${feed.lastPost ? formatDate(feed.lastPost) : 'Never'}</td>
          <td>${feed.postsPerWeek}</td>
          <td>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span>${feed.successRate}%</span>
              <div class="progress-bar" style="width: 60px;">
                <div class="progress-fill" style="width: ${feed.successRate}%"></div>
              </div>
            </div>
          </td>
          <td>${feed.channel}</td>
        </tr>
      `).join('');
    }

    // Load channel statistics
    async function loadChannelStats() {
      try {
        const [channelsData, feedsData] = await Promise.all([
          HanuAPI.getChannels(),
          HanuAPI.getFeeds()
        ]);

        const channels = channelsData.channels || [];
        const mappings = feedsData.mappings || {};

        const container = document.getElementById('channel-stats');
        
        if (channels.length === 0) {
          container.innerHTML = '<div class="loading">No channels configured</div>';
          return;
        }

        let html = '<div class="stats-grid">';
        channels.forEach(channel => {
          const feedCount = Object.values(mappings).filter(id => id === channel.id).length;
          const postsToday = Math.floor(Math.random() * 10); // Mock data
          
          html += `
            <div class="stat-card">
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                💬 ${channel.name || channel.id}
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Feeds:</span>
                <strong>${feedCount}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Posts Today:</span>
                <strong>${postsToday}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Type:</span>
                <strong>${channel.type || 'text'}</strong>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;

      } catch (error) {
        console.error('Failed to load channel stats:', error);
        document.getElementById('channel-stats').innerHTML = '<div class="error">Failed to load channel statistics</div>';
      }
    }

    // Load activity log
    async function loadActivityLog() {
      try {
        // Mock activity data - replace with real API call
        const activities = [
          { time: new Date(Date.now() - 2 * 60 * 1000), action: 'Processed 3 new posts from CLB Dynamic HANU', type: 'success', details: '3 posts successfully sent to Discord' },
          { time: new Date(Date.now() - 15 * 60 * 1000), action: 'Bot run completed successfully', type: 'info', details: 'Processed 44 feeds in 37 seconds' },
          { time: new Date(Date.now() - 32 * 60 * 1000), action: 'Feed metadata refreshed', type: 'info', details: 'Updated metadata for 44 feeds' },
          { time: new Date(Date.now() - 67 * 60 * 1000), action: 'Posted update to Discord channel', type: 'success', details: 'Khoa tiếng Anh announcement posted' },
          { time: new Date(Date.now() - 125 * 60 * 1000), action: 'System prompt updated', type: 'warning', details: 'Admin updated prompt configuration' },
          { time: new Date(Date.now() - 180 * 60 * 1000), action: 'New feed added: CLB SÁCH HANU', type: 'info', details: 'Feed added via dashboard' }
        ];

        const container = document.getElementById('activity-log');
        
        let html = '';
        activities.forEach(activity => {
          const iconMap = {
            success: '✅',
            warning: '⚠️',
            error: '❌',
            info
          }})}}