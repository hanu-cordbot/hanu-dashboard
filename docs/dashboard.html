<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Feed Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <style>
    /* Discord emoji styling */
    img.emoji { height: 1em; width: 1em; margin: 0 0.05em 0 0.1em; vertical-align: -0.1em; }
    
    /* Simple styling matching your preference */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    /* Navigation */
    .nav { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
    .nav a { color: #007bff; text-decoration: none; margin-right: 20px; }
    .nav a:hover { text-decoration: underline; }
    
    /* Header */
    .header { margin-bottom: 30px; }
    .header h1 { margin: 0; color: #495057; font-size: 1.8rem; font-weight: 600; }
    
    /* Auth section */
    .auth-section { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
    .auth-section input { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-right: 10px; width: 300px; }
    .auth-section button { padding: 10px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    /* Status cards */
    .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    .status-card { background: #f8f9fa; padding: 20px; border-radius: 6px; text-align: center; }
    .status-card strong { display: block; margin-bottom: 10px; color: #495057; }
    .status-value { font-size: 1.5rem; font-weight: 600; color: #007bff; }
    
    /* Forms */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; gap: 10px; align-items: center; }
    .form-group input { flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
    .btn { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    
    /* Feeds table */
    .feeds-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .feeds-table th, .feeds-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
    .feeds-table th { background: #f8f9fa; font-weight: 600; }
    .feeds-table tr:hover { background: #f8f9fa; }
    
    /* Sections */
    .section { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
    .section h2 { margin-top: 0; color: #495057; }
    
    /* Hidden */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">üè† Home</a>
      <a href="prompt-editor.html">‚úèÔ∏è Prompt Editor</a>
      <a href="stats.html">üìä Statistics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>ü§ñ Feed Management Dashboard</h1>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>üîê Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button onclick="authenticate()">Login</button>
      <div id="auth-status" style="margin-top: 10px;"></div>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div id="main-content" class="hidden">
      <!-- Status -->
      <div class="status-grid">
        <div class="status-card">
          <strong>ü§ñ Bot Status</strong>
          <div class="status-value" id="bot-status">Loading...</div>
        </div>
        <div class="status-card">
          <strong>üì° Active Feeds</strong>
          <div class="status-value" id="feed-count">0</div>
        </div>
        <div class="status-card">
          <strong>üì® Processed Posts</strong>
          <div class="status-value" id="seen-count">0</div>
        </div>
      </div>

      <!-- Add Feed/Group -->
      <div class="form-row">
        <div class="form-group">
          <input type="text" id="new-feed-url" placeholder="RSS feed URL">
          <button onclick="addFeed()" class="btn btn-primary">‚ûï Add Feed</button>
        </div>
        <div class="form-group">
          <input type="text" id="new-group-name" placeholder="Group name">
          <button onclick="addGroup()" class="btn btn-secondary">üìÅ Add Group</button>
        </div>
      </div>

      <!-- Feeds Section -->
      <div class="section">
        <h2>üìã RSS Feeds</h2>
        <table class="feeds-table">
          <thead>
            <tr>
              <th>Feed Name</th>
              <th>Last Post</th>
              <th>Channel</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="feeds-tbody">
            <tr><td colspan="4">Loading feeds...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Channels Section -->
      <div class="section">
        <h2>üí¨ Discord Channels</h2>
        <div class="form-group" style="margin-bottom: 15px;">
          <input type="text" id="new-channel-id" placeholder="Discord Channel ID">
          <button onclick="addChannel()" class="btn btn-primary">‚ûï Add Channel</button>
        </div>
        <div id="channels-list">Loading channels...</div>
      </div>

      <!-- Bot Controls -->
      <div class="section">
        <h2>üéÆ Bot Controls</h2>
        <div style="display: flex; gap: 15px;">
          <button onclick="runBot()" class="btn btn-success">üöÄ Run Bot</button>
          <button onclick="clearCache()" class="btn btn-secondary">üóëÔ∏è Clear Cache</button>
          <button onclick="refreshData()" class="btn btn-secondary">üîÑ Refresh</button>
        </div>
        <div id="job-output" style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 4px; display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://hanu-cordbot.snacky496.workers.dev';
    let authToken = null;
    let feeds = [];
    let channels = [];

    // Check for stored token on page load
    document.addEventListener('DOMContentLoaded', () => {
      const stored = sessionStorage.getItem('HANU_AUTH_TOKEN');
      if (stored) {
        document.getElementById('auth-token').value = stored;
        authenticate();
      }
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
    });

    async function authenticate() {
      const token = document.getElementById('auth-token').value.trim();
      const status = document.getElementById('auth-status');
      
      if (!token) {
        status.textContent = '‚ùå Please enter AUTH_TOKEN';
        return;
      }

      status.textContent = '‚è≥ Authenticating...';
      
      try {
        const response = await fetch(`${API_BASE}/api/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          authToken = token;
          sessionStorage.setItem('HANU_AUTH_TOKEN', token);
          
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          
          await loadDashboardData();
          
        } else {
          status.textContent = '‚ùå Authentication failed';
        }
      } catch (error) {
        status.textContent = '‚ùå Connection error';
        console.error('Auth error:', error);
      }
    }

    async function loadDashboardData() {
      try {
        // Load feeds
        const feedsResponse = await fetch(`${API_BASE}/api/feeds`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (feedsResponse.ok) {
          const feedsData = await feedsResponse.json();
          feeds = feedsData.feeds || [];
          renderFeeds();
        }

        // Load channels
        const channelsResponse = await fetch(`${API_BASE}/api/channels`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (channelsResponse.ok) {
          const channelsData = await channelsResponse.json();
          channels = channelsData.channels || [];
          renderChannels();
        }

        // Load status
        const statusResponse = await fetch(`${API_BASE}/api/status`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (statusResponse.ok) {
          const statusData = await statusResponse.json();
          document.getElementById('bot-status').textContent = statusData.workerStatus || 'Unknown';
          document.getElementById('feed-count').textContent = feeds.length;
          document.getElementById('seen-count').textContent = statusData.seenCount || 0;
        }

      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function renderFeeds() {
      const tbody = document.getElementById('feeds-tbody');
      
      if (feeds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No feeds configured</td></tr>';
        return;
      }

      tbody.innerHTML = feeds.map(feed => `
        <tr>
          <td>${feed.title || 'Unknown Feed'}</td>
          <td>${feed.lastPost ? new Date(feed.lastPost).toLocaleDateString() : 'Never'}</td>
          <td>Not mapped</td>
          <td>
            <button onclick="removeFeed('${feed.url}')" class="btn btn-danger">üóëÔ∏è Remove</button>
          </td>
        </tr>
      `).join('');
    }

    function renderChannels() {
      const container = document.getElementById('channels-list');
      
      if (channels.length === 0) {
        container.innerHTML = 'No channels configured';
        return;
      }

      container.innerHTML = channels.map(ch => `
        <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 4px;">
          <strong>${ch.name || ch.id}</strong> [${ch.type || 'text'}] 
          <button onclick="removeChannel('${ch.id}')" class="btn btn-danger" style="margin-left: 10px;">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    async function addFeed() {
      const url = document.getElementById('new-feed-url').value.trim();
      if (!url) return;

      try {
        const response = await fetch(`${API_BASE}/api/feeds`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ feedUrl: url })
        });

        if (response.ok) {
          document.getElementById('new-feed-url').value = '';
          await loadDashboardData();
          alert('Feed added successfully! üéâ');
        }
      } catch (error) {
        alert('Failed to add feed: ' + error.message);
      }
    }

    async function runBot() {
      const output = document.getElementById('job-output');
      output.style.display = 'block';
      output.textContent = '‚è≥ Running bot...';

      try {
        const response = await fetch(`${API_BASE}/run`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const result = await response.text();
        output.textContent = `‚úÖ Bot completed:\n${result}`;
      } catch (error) {
        output.textContent = `‚ùå Bot failed: ${error.message}`;
      }
    }

    async function refreshData() {
      await loadDashboardData();
      alert('Data refreshed! üîÑ');
    }

    // Placeholder functions
    function addGroup() { alert('Group management coming soon'); }
    function addChannel() { alert('Channel management coming soon'); }
    function removeFeed(url) { alert('Remove feed: ' + url); }
    function clearCache() { alert('Cache cleared'); }
  </script>
</body>
</html>
