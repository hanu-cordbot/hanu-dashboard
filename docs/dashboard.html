<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Feed Dashboard</title>
  <link href="shared/common.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">🏠 Home</a>
      <a href="dashboard.html" class="active">🤖 Dashboard</a>
      <a href="prompt-editor.html">✏️ Prompt Editor</a>
      <a href="stats.html">📊 Statistics</a>
      <a href="analytics.html">📈 Analytics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>🤖 Feed Management Dashboard</h1>
      <p>Manage RSS feeds and Discord channel mappings for HANU University</p>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>🔐 Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button id="login-button">Login</button>
      <div id="auth-status" style="margin-top: 10px;"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- System Status -->
      <div class="status-grid">
        <div class="status-card">
          <strong>🤖 Bot Status</strong>
          <div class="status-value" id="bot-status">Loading...</div>
        </div>
        <div class="status-card">
          <strong>📡 Active Feeds</strong>
          <div class="status-value" id="feed-count">0</div>
        </div>
        <div class="status-card">
          <strong>📨 Processed Posts</strong>
          <div class="status-value" id="seen-count">0</div>
        </div>
      </div>

      <!-- Real-time System Stats -->
      <div class="status-grid" id="realtime-stats" style="margin-top: 20px; background: #f8f9fa; border-radius: 8px; padding: 15px;">
        <div class="status-card">
          <strong>💾 Memory Usage</strong>
          <div class="status-value" id="memory-usage">--</div>
        </div>
        <div class="status-card">
          <strong>⚡ CPU Usage</strong>
          <div class="status-value" id="cpu-usage">--</div>
        </div>
        <div class="status-card">
          <strong>📈 Activity Rate</strong>
          <div class="status-value" id="activity-rate">--</div>
        </div>
        <div class="status-card">
          <strong>🎯 Health Score</strong>
          <div class="status-value" id="health-score">--</div>
        </div>
      </div>

      <!-- Quick Add Forms -->
      <div class="form-row">
        <div class="form-group">
          <input type="text" id="new-feed-url" placeholder="RSS feed URL">
          <button onclick="addFeed()" class="btn btn-primary">➕ Add Feed</button>
        </div>
        <div class="form-group">
          <input type="text" id="new-group-name" placeholder="Group name">
          <button onclick="addGroup()" class="btn btn-secondary">📁 Add Group</button>
        </div>
      </div>

      <!-- View Controls -->
      <div class="controls">
        <label>View:</label>
        <div class="btn-group">
          <button class="btn btn-outline active" onclick="setView('flat')" id="view-flat">📄 Flat</button>
          <button class="btn btn-outline" onclick="setView('grouped')" id="view-grouped">📁 Grouped</button>
        </div>

        <label>Sort:</label>
        <div class="btn-group">
          <button class="btn btn-outline active" onclick="setSort('name')" id="sort-name">Name</button>
          <button class="btn btn-outline" onclick="setSort('date')" id="sort-date">Date</button>
          <button class="btn btn-outline" onclick="setSort('channel')" id="sort-channel">Channel</button>
          <button class="btn btn-outline" onclick="setSort('group')" id="sort-group">Group</button>
        </div>

        <label>Filter:</label>
        <div class="btn-group">
          <button class="btn btn-outline active" onclick="setFilter('all')" id="filter-all">All</button>
          <button class="btn btn-outline" onclick="setFilter('active')" id="filter-active">Active</button>
          <button class="btn btn-outline" onclick="setFilter('inactive')" id="filter-inactive">Inactive</button>
        </div>
      </div>

      <!-- Feeds Section -->
      <div class="section">
        <h2>📋 RSS Feeds</h2>
        <div id="feeds-container">
          <div class="loading">Loading feeds...</div>
        </div>
      </div>

      <!-- Channels Section -->
      <div class="section">
        <h2>💬 Discord Channels</h2>
        <div class="form-group mb-15">
          <input type="text" id="new-channel-id" placeholder="Discord Channel ID (e.g., 1393802593704083486)">
          <button onclick="addChannel()" class="btn btn-primary">➕ Add Channel</button>
          <small style="display: block; margin-top: 5px; color: #6c757d;">
            💡 Channel names will be fetched instantly from Discord
          </small>
        </div>
        
        <div id="channels-list">
          <div class="loading">Loading channels...</div>
        </div>
      </div>

            <!-- Bot Controls -->
      <div class="section">
        <h2>🎮 Bot Controls</h2>
        <div class="flex gap-15">
          <button onclick="runBot()" class="btn btn-success" id="run-bot-btn">🚀 Run Bot Now</button>
          <button onclick="clearCache()" class="btn btn-secondary">🗑️ Clear Cache</button>
          <button onclick="refreshData()" class="btn btn-secondary">🔄 Refresh Data</button>
          <button onclick="exportData()" class="btn btn-outline">📥 Export Data</button>
        </div>
        
        <div id="job-output" class="code-output hidden mt-15"></div>
      </div>

      <!-- ADD THIS ENTIRE SECTION HERE: -->
      <div class="section">
        <h2>🧪 Test Controls</h2>
        <div class="form-group mb-15">
          <select id="test-feed-select" style="width: 300px; margin-right: 10px;">
            <option value="">Select feed to test...</option>
          </select>
          <label style="margin-right: 15px;">
            <input type="checkbox" id="skip-filters" checked> Skip age/seen filters
          </label>
          <div class="flex gap-15">
          <button onclick="wakeBotService()" class="btn btn-info" id="wake-bot-btn">⏰ Wake Bot</button>
          <button onclick="triggerTestPost()" class="btn btn-warning" id="test-post-btn">🧪 Test Post</button>
        </div>
        <div id="test-output" class="code-output hidden mt-15"></div>
      </div>

  <!-- Group Rename Modal -->
  <div id="rename-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; min-width: 400px;">
      <h3>📝 Rename Group</h3>
      <p>Current name: <strong id="current-group-name"></strong></p>
      <input type="text" id="new-group-name-input" placeholder="Enter new group name" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="cancelRenameGroup()" class="btn btn-secondary">Cancel</button>
        <button onclick="confirmRenameGroup()" class="btn btn-primary">Rename</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import HanuAuth from './shared/auth.js';
    import HanuAPI from './shared/api.js';
    import Analytics from './shared/analytics.js';

    // Dashboard state
    let feeds = [];
    let channels = [];
    let groups = {};
    let feedMappings = {};
    let currentView = 'flat';
    let currentSort = 'name';
    let currentFilter = 'all';
    let feedMetadata = {};
    let statsInterval = null;
    let currentRenameGroup = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('🚀 Dashboard initializing...');
      
      // Setup authentication UI FIRST
      HanuAuth.setupAuthUI();
      console.log('🔐 Auth UI setup complete');
      
      // Setup authentication callback
      HanuAuth.onLogin(async () => {
        console.log('✅ User authenticated, loading dashboard...');
        await loadAllData();
        startStatsUpdates();
      });
      
      // Parse emojis
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
      
      // Auto-load if already authenticated
      if (HanuAuth.isAuthenticated()) {
        console.log('🔍 Testing existing authentication...');
        const isValid = await HanuAuth.testAuth();
        if (isValid) {
          console.log('✅ Auto-login successful');
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          await loadAllData();
          startStatsUpdates();
        } else {
          console.log('❌ Existing auth invalid, clearing...');
          HanuAuth.clearToken();
        }
      }
    });

    // Start real-time stats updates
    function startStatsUpdates() {
      if (statsInterval) clearInterval(statsInterval);
      
      // Update immediately
      updateRealTimeStats();
      
      // Then update every 30 seconds
      statsInterval = setInterval(updateRealTimeStats, 30000);
    }

    // Update real-time statistics
    async function updateRealTimeStats() {
      try {
        const stats = await HanuAPI.getSystemStats();
        
        document.getElementById('memory-usage').textContent = `${stats.memory || 0} KB`;
        document.getElementById('cpu-usage').textContent = `${stats.cpu || 0}%`;
        document.getElementById('activity-rate').textContent = `${stats.activityRate || 0}%`;
        document.getElementById('health-score').textContent = `${stats.healthScore || 0}/100`;
        
        // Update basic status cards too
        document.getElementById('feed-count').textContent = `${stats.activeFeedCount || 0}/${stats.feedCount || 0}`;
        
        console.log('📊 Stats updated');
        
      } catch (error) {
        console.error('Failed to update real-time stats:', error);
        // Show placeholder values on error
        document.getElementById('memory-usage').textContent = 'Error';
        document.getElementById('cpu-usage').textContent = 'Error';
        document.getElementById('activity-rate').textContent = 'Error';
        document.getElementById('health-score').textContent = 'Error';
      }
    }

    // Load all dashboard data
    async function loadAllData() {
      try {
        console.log('📊 Loading all dashboard data...');
        
        const [feedsData, channelsData, statusData] = await Promise.all([
          HanuAPI.getFeeds(),
          HanuAPI.getChannels(),
          HanuAPI.getSystemStatus()
        ]);

        feeds = feedsData.feeds || [];
        channels = channelsData.channels || [];
        groups = feedsData.groups || {};
        feedMappings = feedsData.mappings || {};
        feedMetadata = feedsData.metadata || {};

        console.log(`📊 Loaded: ${feeds.length} feeds, ${channels.length} channels`);

        updateStatusCards(statusData);
        renderFeeds();
        renderChannels();
        populateTestFeedDropdown();

      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    // Update status cards
    function updateStatusCards(statusData) {
      document.getElementById('bot-status').textContent = statusData.workerStatus || 'Unknown';
      document.getElementById('seen-count').textContent = statusData.seenCount || 0;
    }

    // Render feeds based on current view/sort/filter
    function renderFeeds() {
      const container = document.getElementById('feeds-container');
      
      if (feeds.length === 0) {
        container.innerHTML = '<div class="loading">No feeds configured</div>';
        return;
      }

      // Apply filters
      let filteredFeeds = feeds.filter(feed => {
        if (currentFilter === 'all') return true;
        if (currentFilter === 'active') return isActiveFeed(feed);
        if (currentFilter === 'inactive') return !isActiveFeed(feed);
        return true;
      });

      // Apply sorting
      filteredFeeds.sort((a, b) => {
        switch (currentSort) {
          case 'name':
            return (getTitle(a) || '').localeCompare(getTitle(b) || '');
          case 'date':
            return new Date(getLastPost(b) || 0) - new Date(getLastPost(a) || 0);
          case 'channel':
            return getChannelName(a).localeCompare(getChannelName(b));
          case 'group':
            return (getGroup(a) || '').localeCompare(getGroup(b) || '');
          default:
            return 0;
        }
      });

      if (currentView === 'grouped') {
        renderGroupedFeeds(filteredFeeds);
      } else {
        renderFlatFeeds(filteredFeeds);
      }
      
      twemoji.parse(container, { folder: 'svg', ext: '.svg' });
    }

    // Render flat feed list
    function renderFlatFeeds(feedList) {
      const container = document.getElementById('feeds-container');
      
      let html = `
        <table class="feeds-table">
          <thead>
            <tr>
              <th>📋 Name</th>
              <th>📅 Last Post</th>
              <th>💬 Channel</th>
              <th>📁 Group</th>
              <th>🔗 Link</th>
              <th>⚙️ Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      feedList.forEach(feed => {
        const title = getTitle(feed);
        const lastPost = formatDate(getLastPost(feed));
        const channelName = getChannelName(feed);
        const groupName = getGroup(feed) || 'None';
        const pageUrl = getPageUrl(feed);
        const isActive = isActiveFeed(feed);

        html += `
          <tr class="${isActive ? '' : 'text-muted'}">
            <td>
              <div class="feed-title">${title}</div>
              <small class="text-muted">${feed.url.substring(0, 60)}...</small>
            </td>
            <td>
              <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">${isActive ? '🟢' : '🔴'}</span>
              ${lastPost}
            </td>
            <td>
              <select onchange="updateFeedChannel('${feed.url}', this.value)" style="font-size: 12px;">
                <option value="">No Channel</option>
                ${channels.map(ch => {
                  const displayName = getChannelDisplayName(ch);
                  return `<option value="${ch.id}" ${feedMappings[feed.url] == ch.id ? 'selected' : ''}>${displayName}</option>`;
                }).join('')}
              </select>
            </td>
            <td>
              <select onchange="updateFeedGroup('${feed.url}', this.value)" style="font-size: 12px;">
                <option value="">No Group</option>
                ${Object.keys(groups).map(g => 
                  `<option value="${g}" ${getGroup(feed) === g ? 'selected' : ''}>${g}</option>`
                ).join('')}
              </select>
            </td>
            <td>
              <a href="${pageUrl}" target="_blank" class="btn btn-outline" style="font-size: 12px;">🔗 Visit</a>
            </td>
            <td>
              <button onclick="removeFeed('${feed.url}')" class="btn btn-danger" style="font-size: 12px;">🗑️</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Render grouped feed list with group management
    function renderGroupedFeeds(feedList) {
      const container = document.getElementById('feeds-container');
      
      // Group feeds by their assigned groups
      const groupedFeeds = {};
      feedList.forEach(feed => {
        const group = getGroup(feed) || 'Ungrouped';
        if (!groupedFeeds[group]) groupedFeeds[group] = [];
        groupedFeeds[group].push(feed);
      });

      // Add empty groups that exist but have no feeds
      Object.keys(groups).forEach(groupName => {
        if (!groupedFeeds[groupName]) {
          groupedFeeds[groupName] = [];
        }
      });

      let html = '';
      Object.entries(groupedFeeds).forEach(([groupName, groupFeeds]) => {
        const isEmpty = groupFeeds.length === 0;
        
        html += `
          <div class="card mb-20">
            <div class="card-header flex-between">
              <div class="card-title">📁 ${groupName} (${groupFeeds.length})</div>
              <div>
                <button onclick="toggleGroup('${groupName}')" class="btn btn-outline">👁️ Toggle</button>
                ${groupName !== 'Ungrouped' ? `
                  <button onclick="renameGroup('${groupName}')" class="btn btn-secondary">✏️ Rename</button>
                  <button onclick="removeGroup('${groupName}')" class="btn btn-danger">🗑️</button>
                ` : ''}
              </div>
            </div>
            <div class="group-feeds" id="group-${groupName}">
              ${isEmpty ? 
                '<div style="padding: 20px; text-align: center; color: #666; font-style: italic;">📭 No feeds in this group yet</div>' : 
                `<table class="feeds-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Last Post</th>
                      <th>Channel</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${groupFeeds.map(feed => `
                      <tr>
                        <td>${getTitle(feed)}</td>
                        <td>${formatDate(getLastPost(feed))}</td>
                        <td>${getChannelName(feed)}</td>
                        <td>
                          <button onclick="removeFeed('${feed.url}')" class="btn btn-danger" style="font-size: 12px;">🗑️</button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>`
              }
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Render channels list
    function renderChannels() {
      const container = document.getElementById('channels-list');
      
      if (channels.length === 0) {
        container.innerHTML = '<div class="loading">No channels configured</div>';
        return;
      }

      let html = '';
      channels.forEach(channel => {
        const feedCount = Object.values(feedMappings).filter(id => id == channel.id).length;
        const displayName = getChannelDisplayName(channel);
        
        html += `
          <div class="card mb-10">
            <div class="flex-between">
              <div>
                <strong>${displayName}</strong>
                <small class="text-muted">ID: ${channel.id}</small>
                <span class="badge bg-info">${feedCount} feeds</span>
              </div>
              <button onclick="removeChannel('${channel.id}')" class="btn btn-danger">🗑️ Remove</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Helper functions
    function getTitle(feed) {
      return feedMetadata[feed.url]?.title || feed.title || 'Unknown Feed';
    }

    function getLastPost(feed) {
      return feedMetadata[feed.url]?.last_post || feed.lastPost || null;
    }

    function getPageUrl(feed) {
      return feedMetadata[feed.url]?.page_url || feed.pageUrl || feed.url;
    }

    function getGroup(feed) {
      for (const [groupName, feedList] of Object.entries(groups)) {
        if (Array.isArray(feedList) && feedList.includes(feed.url)) {
          return groupName;
        }
      }
      return null;
    }

    function getChannelName(feed) {
      const channelId = feedMappings[feed.url];
      if (!channelId) return 'None';
      const channel = channels.find(ch => ch.id == channelId);
      return channel ? getChannelDisplayName(channel) : 'Unknown';
    }

    function getChannelDisplayName(channel) {
      const emoji = channel.type === 'forum' ? '💬' : (channel.type === 'voice' ? '🔊' : '📝');
      const name = channel.name || `Channel-${channel.id.toString().slice(-4)}`;
      return `${emoji} ${name}`;
    }

    function isActiveFeed(feed) {
      const channelId = feedMappings[feed.url];
      const hasMappedChannel = !!channelId;
      
      const lastPost = getLastPost(feed);
      const hasRecentPost = lastPost && (Date.now() - new Date(lastPost)) <= (14 * 24 * 60 * 60 * 1000);
      
      return hasMappedChannel || hasRecentPost;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
      
      if (diffHours < 24) {
        return diffHours < 1 ? 'Just now' : `${diffHours}h ago`;
      } else {
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
      }
    }

    // View/Sort/Filter controls
    window.setView = function(view) {
      currentView = view;
      document.getElementById('view-flat').classList.toggle('active', view === 'flat');
      document.getElementById('view-grouped').classList.toggle('active', view === 'grouped');
      renderFeeds();
    };

    window.setSort = function(sort) {
      currentSort = sort;
      document.querySelectorAll('[id^="sort-"]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`sort-${sort}`).classList.add('active');
      renderFeeds();
    };

    window.setFilter = function(filter) {
      currentFilter = filter;
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`filter-${filter}`).classList.add('active');
      renderFeeds();
    };

    // FIXED: Single addFeed function with analytics
    window.addFeed = async function() {
      const input = document.getElementById('new-feed-url');
      const url = input.value.trim();
      
      if (!url) {
        Analytics.trackDashboardAction('add_feed_failed', { reason: 'empty_url' });
        showAlert('Please enter a feed URL', 'warning');
        return;
      }

      Analytics.trackDashboardAction('add_feed_attempt');
      const startTime = Date.now();

      try {
        await HanuAPI.addFeed(url);
        
        Analytics.trackAPICall('/api/feeds', Date.now() - startTime, true);
        Analytics.trackDashboardAction('add_feed_success', { url: url.includes('facebook') ? 'facebook' : 'other' });
        
        input.value = '';
        await loadAllData();
        showAlert('Feed added successfully! 🎉', 'success');
      } catch (error) {
        Analytics.trackAPICall('/api/feeds', Date.now() - startTime, false);
        Analytics.trackDashboardAction('add_feed_failed', { reason: 'api_error' });
        Analytics.trackError(error, 'add_feed');
        showAlert('Failed to add feed: ' + error.message, 'danger');
      }
    };

    window.removeFeed = async function(feedUrl) {
      if (!confirm('Are you sure you want to remove this feed?')) return;

      try {
        await HanuAPI.removeFeed(feedUrl);
        await loadAllData();
        showAlert('Feed removed successfully', 'success');
      } catch (error) {
        showAlert('Failed to remove feed: ' + error.message, 'danger');
      }
    };

    window.updateFeedChannel = async function(feedUrl, channelId) {
      try {
        await HanuAPI.updateFeedMapping(feedUrl, channelId);
        feedMappings[feedUrl] = channelId;
        showAlert('Channel mapping updated! ✅', 'success');
      } catch (error) {
        showAlert('Failed to update mapping: ' + error.message, 'danger');
      }
    };

    window.updateFeedGroup = async function(feedUrl, groupName) {
      try {
        await HanuAPI.updateFeedGroup(feedUrl, groupName);
        await loadAllData();
        showAlert('Group updated! ✅', 'success');
      } catch (error) {
        showAlert('Failed to update group: ' + error.message, 'danger');
      }
    };

    // Group management
    window.addGroup = async function() {
      const input = document.getElementById('new-group-name');
      const name = input.value.trim();
      
      if (!name) {
        showAlert('Please enter a group name', 'warning');
        return;
      }

      try {
        await HanuAPI.addGroup(name);
        input.value = '';
        await loadAllData();
        showAlert('Group created successfully! 📁', 'success');
      } catch (error) {
        showAlert('Failed to create group: ' + error.message, 'danger');
      }
    };

    window.renameGroup = function(groupName) {
      currentRenameGroup = groupName;
      document.getElementById('current-group-name').textContent = groupName;
      document.getElementById('new-group-name-input').value = groupName;
      document.getElementById('rename-group-modal').style.display = 'block';
      document.getElementById('new-group-name-input').focus();
    };

    window.cancelRenameGroup = function() {
      document.getElementById('rename-group-modal').style.display = 'none';
      currentRenameGroup = null;
    };

    window.confirmRenameGroup = async function() {
      const newName = document.getElementById('new-group-name-input').value.trim();
      
      if (!newName) {
        showAlert('Please enter a new group name', 'warning');
        return;
      }

      if (newName === currentRenameGroup) {
        cancelRenameGroup();
        return;
      }

      try {
        await HanuAPI.renameGroup(currentRenameGroup, newName);
        await loadAllData();
        showAlert(`Group renamed from "${currentRenameGroup}" to "${newName}"! ✏️`, 'success');
        cancelRenameGroup();
      } catch (error) {
        showAlert('Failed to rename group: ' + error.message, 'danger');
      }
    };

    window.removeGroup = async function(groupName) {
      if (!confirm(`Remove group "${groupName}"? Feeds will become ungrouped.`)) return;

      try {
        await HanuAPI.removeGroup(groupName);
        await loadAllData();
        showAlert('Group removed successfully', 'success');
      } catch (error) {
        console.error('Group removal error:', error);
        showAlert('Failed to remove group: ' + error.message, 'danger');
      }
    };

    window.toggleGroup = function(groupName) {
      const groupElement = document.getElementById(`group-${groupName}`);
      if (groupElement) {
        groupElement.style.display = groupElement.style.display === 'none' ? 'block' : 'none';
      }
    };

    // Channel management
    window.addChannel = async function() {
      const idInput = document.getElementById('new-channel-id');
      const channelId = idInput.value.trim();
      
      if (!channelId) {
        showAlert('Please enter a channel ID', 'warning');
        return;
      }

      if (!/^\d{17,20}$/.test(channelId)) {
        showAlert('Invalid Discord channel ID format. Should be 17-20 digits.', 'warning');
        return;
      }

      try {
        await HanuAPI.addChannel(channelId);
        idInput.value = '';
        
        showAlert('Channel added! Fetching name from Discord...', 'info');
        
        try {
          await HanuAPI.fetchChannelName(channelId);
          setTimeout(async () => {
            await loadAllData();
            showAlert('Channel name fetched successfully! 💬', 'success');
          }, 1000);
        } catch (fetchError) {
          await loadAllData();
          showAlert('Channel added! Name will be updated when bot runs. 💬', 'success');
        }
        
      } catch (error) {
        showAlert('Failed to add channel: ' + error.message, 'danger');
      }
    };

    window.removeChannel = async function(channelId) {
      const feedCount = Object.values(feedMappings).filter(id => id == channelId).length;
      if (feedCount > 0 && !confirm(`This channel has ${feedCount} mapped feeds. Remove anyway?`)) return;

      try {
        await HanuAPI.removeChannel(channelId);
        await loadAllData();
        showAlert('Channel removed successfully', 'success');
      } catch (error) {
        showAlert('Failed to remove channel: ' + error.message, 'danger');
      }
    };

    // Bot controls
    window.runBot = async function() {
      const button = document.getElementById('run-bot-btn');
      const output = document.getElementById('job-output');
      
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Running...';
      output.classList.remove('hidden');
      output.textContent = '⏳ Starting bot job...\n💡 This may take 2-3 minutes to complete.';

      try {
        console.log('🚀 Triggering bot run via Railway...');
        
        const response = await fetch('https://web-production-b0a5.up.railway.app/run', {
          method: 'POST',
          headers: {
            'X-Auth': HanuAuth.getToken(),
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          output.textContent = `✅ Bot job completed successfully!\n\nDetails: ${JSON.stringify(result.result || result.message, null, 2)}`;
          
          setTimeout(async () => {
            await loadAllData();
            showAlert('📱 Data refreshed after bot run!', 'info');
          }, 2000);
        } else {
          output.textContent = `❌ Bot job failed!\n\nError: ${result.error || result.message}`;
        }
        
      } catch (error) {
        output.textContent = `❌ Failed to trigger bot job: ${error.message}`;
        console.error('Bot run error:', error);
      } finally {
        button.disabled = false;
        button.innerHTML = '🚀 Run Bot Now';
      }
    };

    window.clearCache = async function() {
      try {
        await HanuAPI.clearCache();
        showAlert('Cache cleared successfully! 🗑️', 'success');
      } catch (error) {
        showAlert('Failed to clear cache: ' + error.message, 'danger');
      }
    };

    window.refreshData = async function() {
      try {
        await loadAllData();
        await updateRealTimeStats();
        showAlert('Data refreshed successfully! 🔄', 'success');
      } catch (error) {
        showAlert('Failed to refresh data: ' + error.message, 'danger');
      }
    };

    window.exportData = function() {
      const data = {
        feeds,
        channels, 
        groups,
        feedMappings,
        feedMetadata,
        exportedAt: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hanu-dashboard-export-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showAlert('Data exported successfully! 📥', 'success');
    };

    // Alert helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fade-in`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      alertDiv.textContent = message;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (statsInterval) clearInterval(statsInterval);
    });

    // Handle Enter key in rename modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.getElementById('rename-group-modal').style.display === 'block') {
        confirmRenameGroup();
      }
      if (e.key === 'Escape' && document.getElementById('rename-group-modal').style.display === 'block') {
        cancelRenameGroup();
      }
    });

    // Track all button clicks automatically
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.classList.contains('btn')) {
        Analytics.trackClick(e.target);
      }
    });

    // Track form submissions
    document.addEventListener('submit', (e) => {
      Analytics.trackEvent('form_submit', 'interaction', {
        form: e.target.id || 'unknown'
      });
    });

        // REPLACE THE ENTIRE triggerTestPost FUNCTION WITH THIS:
    window.triggerTestPost = async function() {
      const feedSelect = document.getElementById('test-feed-select');
      const skipFilters = document.getElementById('skip-filters').checked;
      const button = document.getElementById('test-post-btn');
      const output = document.getElementById('test-output');
      
      const feedUrl = feedSelect.value;
      if (!feedUrl) {
        showAlert('Please select a feed to test', 'warning');
        return;
      }
      
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Testing...';
      output.classList.remove('hidden');

      try {
        // Step 1: Wake up Railway (quick health check)
        output.textContent = '⏰ Waking up Railway bot...';
        
        try {
          await fetch('https://web-production-b0a5.up.railway.app/health', {
            method: 'GET',
            signal: AbortSignal.timeout(30000) // 30 second timeout for wake-up
          });
          output.textContent += '\n✅ Railway bot is awake!';
        } catch (wakeError) {
          output.textContent += '\n⚠️ Wake-up timeout, continuing anyway...';
        }
        
        // Step 2: Wait a moment for full wake-up
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Step 3: Trigger test post with longer timeout
        output.textContent += '\n🧪 Triggering test post...';
        
        const response = await fetch('https://hanu-cordbot.snacky496.workers.dev/api/test-post', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${HanuAuth.getToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            feedUrl: feedUrl,
            skipFilters: skipFilters
          }),
          signal: AbortSignal.timeout(180000) // 3 minute timeout for actual work
        });
        
        const result = await response.json();
        
        if (result.success) {
          output.textContent = `✅ Test completed successfully!\n\nFeed: ${feedUrl}\nSkip Filters: ${skipFilters}\nResult: ${JSON.stringify(result, null, 2)}`;
          showAlert('Test post triggered! Check your Discord channel. 🧪', 'success');
        } else {
          throw new Error(result.error || 'Test failed');
        }
        
      } catch (error) {
        console.error('Test post error:', error);
        
        if (error.name === 'TimeoutError') {
          output.textContent = `⏰ Request timed out!\n\nThe Railway bot may be sleeping and taking too long to wake up.\nTry again in a few minutes, or use the regular "Run Bot Now" button.\n\nError: ${error.message}`;
          showAlert('Request timed out - Railway bot may be sleeping. Try again in a few minutes.', 'warning');
        } else {
          output.textContent = `❌ Test failed: ${error.message}`;
          showAlert('Test post failed: ' + error.message, 'danger');
        }
      } finally {
        button.disabled = false;
        button.innerHTML = '🧪 Test Post';
      }
    };

      const feedSelect = document.getElementById('test-feed-select');
      const skipFilters = document.getElementById('skip-filters').checked;
      const button = document.getElementById('test-post-btn');
      const output = document.getElementById('test-output');
      
      const feedUrl = feedSelect.value;
      if (!feedUrl) {
        showAlert('Please select a feed to test', 'warning');
        return;
      }
      
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Testing...';
      output.classList.remove('hidden');
      output.textContent = '🧪 Triggering test post...';
      
      try {
        const response = await fetch('https://hanu-cordbot.snacky496.workers.dev/api/test-post', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${HanuAuth.getToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            feedUrl: feedUrl,
            skipFilters: skipFilters
          })
        });
        
        const result = await response.json();
        
        output.textContent = `✅ Test completed!\n\nFeed: ${feedUrl}\nSkip Filters: ${skipFilters}\nResult: ${JSON.stringify(result, null, 2)}`;
        showAlert('Test post triggered! Check your Discord channel. 🧪', 'success');
        
      } catch (error) {
        output.textContent = `❌ Test failed: ${error.message}`;
        showAlert('Test post failed: ' + error.message, 'danger');
      } finally {
        button.disabled = false;
        button.innerHTML = '🧪 Test Post';
      }

    // Populate test dropdown with mapped feeds only
    function populateTestFeedDropdown() {
      const select = document.getElementById('test-feed-select');
      if (!select) return;
      
      // Clear existing options except the first one
      select.innerHTML = '<option value="">Select feed to test...</option>';
      
      // Add only mapped feeds
      Object.keys(feedMappings).forEach(feedUrl => {
        const title = getTitle({ url: feedUrl }) || feedUrl;
        const option = document.createElement('option');
        option.value = feedUrl;
        option.textContent = title.substring(0, 50) + (title.length > 50 ? '...' : '');
        select.appendChild(option);
      });
    }
  </script>
</body>
</html>
