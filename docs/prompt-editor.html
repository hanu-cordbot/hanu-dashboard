<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Prompt Editor</title>
  <link href="shared/common.css" rel="stylesheet">
  <!-- Discord-style emoji rendering -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Discord-style emoji rendering */
    img.emoji {
      height: 1em;
      width: 1em;
      margin: 0 0.05em 0 0.1em;
      vertical-align: -0.1em;
    }
    
    /* Discord Theme */
    body { 
      font-family: "Whitney", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #36393f;
      color: #dcddde;
      margin: 0;
      padding: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Navigation */
    .nav-bar {
      background: #2f3136;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-links a {
      color: #00d4aa;
      text-decoration: none;
      margin: 0 15px;
      font-weight: 500;
    }
    .nav-links a:hover {
      color: #00f5cc;
    }
    
    /* Header */
    .prompt-header {
      background: linear-gradient(135deg, #5865f2 0%, #3ba55d 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
    }
    .prompt-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    /* Section */
    .section {
      background: #2f3136;
      border: 2px solid #40444b;
      padding: 25px;
      margin: 20px 0;
      border-radius: 8px;
      transition: border-color 0.2s;
    }
    .section:hover {
      border-color: #5865f2;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #40444b;
    }
    .section input[name="section_name"] {
      font-weight: 600;
      font-size: 18px;
      border: none;
      background: #40444b;
      color: #dcddde;
      padding: 10px 15px;
      border-radius: 6px;
      width: 300px;
    }
    .section textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      background: #40444b;
      color: #dcddde;
      border: 1px solid #40444b;
      border-radius: 6px;
      padding: 15px;
      resize: vertical;
      line-height: 1.4;
    }
    .section textarea:focus {
      outline: none;
      border-color: #5865f2;
    }
    .preview {
      margin-top: 20px;
      padding: 20px;
      background: #36393f;
      border: 1px solid #40444b;
      border-radius: 6px;
      border-left: 4px solid #00d4aa;
    }
    .preview h1, .preview h2, .preview h3 {
      color: #dcddde;
      margin-top: 0;
    }
    .preview p {
      color: #b9bbbe;
      line-height: 1.6;
    }
    .preview code {
      background: #2f3136;
      color: #00d4aa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-size: 14px;
    }
    .btn-primary {
      background: #5865f2;
      color: white;
    }
    .btn-primary:hover {
      background: #4752c4;
      transform: translateY(-1px);
    }
    .btn-success {
      background: #3ba55d;
      color: white;
    }
    .btn-success:hover {
      background: #2d7d42;
      transform: translateY(-1px);
    }
    .btn-danger {
      background: #ed4245;
      color: white;
    }
    .btn-danger:hover {
      background: #c23b3d;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #4f545c;
      color: #dcddde;
    }
    .btn-secondary:hover {
      background: #5d6269;
      transform: translateY(-1px);
    }
    
    /* Action Bar */
    .action-bar {
      background: #2f3136;
      padding: 20px;
      border-radius: 8px;
      margin: 30px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    /* Test Area */
    .test-area {
      background: #2f3136;
      padding: 25px;
      border-radius: 8px;
      margin: 30px 0;
      border-left: 4px solid #5865f2;
    }
    .test-area h3 {
      color: #dcddde;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .test-content {
      width: 100%;
      min-height: 120px;
      background: #40444b;
      color: #dcddde;
      border: 1px solid #40444b;
      border-radius: 6px;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      resize: vertical;
    }
    .test-content:focus {
      outline: none;
      border-color: #5865f2;
    }
    .test-controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
    }
    .test-result {
      background: #36393f;
      padding: 20px;
      margin: 15px 0;
      border: 1px solid #40444b;
      border-radius: 6px;
      border-left: 4px solid #00d4aa;
    }
    .test-result h4 {
      color: #dcddde;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .test-result-content {
      background: #2f3136;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', monospace;
      color: #b9bbbe;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    
    /* Status Messages */
    .save-status {
      margin: 20px 0;
    }
    .status-success {
      background: #2d4a3a;
      color: #3ba55d;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #3ba55d;
    }
    .status-error {
      background: #4a2d2d;
      color: #ed4245;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #ed4245;
    }
    .status-loading {
      background: #3d3d4a;
      color: #5865f2;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #5865f2;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .section-header { flex-direction: column; gap: 15px; }
      .action-bar { flex-direction: column; }
      .test-controls { flex-direction: column; }
    }
    
    /* Utility */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav-bar">
      <div class="nav-links">
        <a href="index.html">üè† Home</a>
        <a href="dashboard.html">ü§ñ Dashboard</a>
        <a href="stats.html">üìä Statistics</a>
      </div>
      <div style="color: #72767d; font-size: 14px;">
        Prompt Configuration
      </div>
    </div>

    <!-- Header -->
    <div class="prompt-header">
      <h1>‚úèÔ∏è System Prompt Editor</h1>
      <p>Configure AI system prompts that control how the bot processes RSS feeds</p>
    </div>

    <!-- Main Editor -->
    <div id="main-editor" class="hidden">
      <div id="sections-container">
        <!-- Dynamic sections will be inserted here -->
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <button onclick="addSection()" class="btn btn-success">‚ûï Add Section</button>
        <button onclick="savePrompt()" class="btn btn-primary">üíæ Save Prompt</button>
        <button onclick="loadPrompt()" class="btn btn-secondary">üîÑ Reload</button>
        <button onclick="exportPrompt()" class="btn btn-secondary">üì§ Export</button>
      </div>

      <!-- Prompt Testing -->
      <div class="test-area">
        <h3>üß™ Test Prompt with AI</h3>
        <p style="color: #b9bbbe; margin-bottom: 15px;">Test your prompt configuration with sample RSS feed content to see how the AI will respond.</p>
        
        <label style="display: block; color: #dcddde; font-weight: 600; margin-bottom: 8px;">Sample Feed Content:</label>
        <textarea id="test-content" class="test-content" placeholder="Paste RSS feed content here for testing...">
Ti√™u ƒë·ªÅ: CLB Thanh ni√™n v·∫≠n ƒë·ªông hi·∫øn m√°u th√¥ng b√°o
N·ªôi dung: Th√¥ng b√°o ƒë·∫øn c√°c b·∫°n sinh vi√™n v·ªÅ ch∆∞∆°ng tr√¨nh hi·∫øn m√°u nh√¢n ƒë·∫°o s·∫Ω ƒë∆∞·ª£c t·ªï ch·ª©c v√†o ng√†y 25/7/2025 t·∫°i h·ªôi tr∆∞·ªùng A1. M·ªùi c√°c b·∫°n tham gia ·ªßng h·ªô ho·∫°t ƒë·ªông √Ω nghƒ©a n√†y.
Ng√†y ƒëƒÉng: 2025-07-21T08:00:00
        </textarea>

        <div class="test-controls">
          <button onclick="testPrompt()" class="btn btn-primary">üöÄ Test with AI</button>
          <button onclick="clearTest()" class="btn btn-secondary">üóëÔ∏è Clear</button>
        </div>

        <div id="test-results"></div>
      </div>

      <!-- Save Status -->
      <div id="save-status" class="save-status"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="shared/auth.js"></script>
  <script src="shared/api.js"></script>
  <script>
    let sections = [];

    // Initialize when authenticated
    window.addEventListener('hanu-authenticated', async () => {
      document.getElementById('main-editor').classList.remove('hidden');
      await loadPrompt();
      parseEmojis();
    });

    // Load current system prompt
    async function loadPrompt() {
      try {
        const data = await window.HanuAPI.getSystemPrompt();
        sections = data.sections || [
          {
            name: "System Role",
            content: "B·∫°n l√† tr·ª£ l√Ω tin t·ª©c c·ªßa tr∆∞·ªùng ƒê·∫°i h·ªçc H√† N·ªôi. Nhi·ªám v·ª• c·ªßa b·∫°n l√† x·ª≠ l√Ω n·ªôi dung RSS feed v√† t·∫°o t√≥m t·∫Øt h·∫•p d·∫´n cho c√°c b√†i ƒëƒÉng Discord."
          },
          {
            name: "Output Format",
            content: "ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi c·ªßa b·∫°n nh∆∞ sau:\n\n**T√≥m t·∫Øt**: T√≥m t·∫Øt ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát\n**Chi ti·∫øt**: Th√¥ng tin chi ti·∫øt\n**Li√™n quan**: Th√¥ng tin li√™n quan ƒë·∫øn sinh vi√™n"
          }
        ];

        renderSections();
        updateAllPreviews();
        parseEmojis();
      } catch (error) {
        console.error('Failed to load prompt:', error);
        showError('Failed to load prompt: ' + error.message);
        // Initialize with default sections if load fails
        sections = [{
          name: "Default Section",
          content: "Enter your prompt content here..."
        }];
        renderSections();
      }
    }

    // Render all sections
    function renderSections() {
      const container = document.getElementById('sections-container');
      
      container.innerHTML = sections.map((section, index) => `
        <div class="section" data-index="${index}">
          <div class="section-header">
            <input type="text" name="section_name" value="${section.name}" 
                   onchange="updateSectionName(${index}, this.value)" 
                   placeholder="Section Name">
            <button onclick="removeSection(${index})" class="btn btn-danger">üóëÔ∏è Remove</button>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; color: #dcddde; font-weight: 600; margin-bottom: 8px;">
              Content (supports Markdown):
            </label>
            <textarea name="section_content" 
                      onchange="updateSectionContent(${index}, this.value)" 
                      oninput="updatePreview(${index})" 
                      rows="8">${section.content}</textarea>
          </div>
          
          <div class="preview" id="preview-${index}">
            <!-- Preview will be inserted here -->
          </div>
        </div>
      `).join('');

      // Update all previews after rendering
      setTimeout(updateAllPreviews, 100);
    }

    // Update section name
    function updateSectionName(index, name) {
      if (sections[index]) {
        sections[index].name = name;
      }
    }

    // Update section content
    function updateSectionContent(index, content) {
      if (sections[index]) {
        sections[index].content = content;
      }
    }

    // Update individual preview
    function updatePreview(index) {
      const preview = document.getElementById(`preview-${index}`);
      const textarea = document.querySelector(`[data-index="${index}"] textarea`);
      
      if (preview && textarea) {
        try {
          if (typeof marked !== 'undefined') {
            preview.innerHTML = marked.parse(textarea.value);
          } else {
            preview.innerHTML = '<em>Markdown preview unavailable</em>';
          }
        } catch (error) {
          preview.innerHTML = '<em>Markdown preview error</em>';
        }
      }
    }

    // Update all previews
    function updateAllPreviews() {
      sections.forEach((_, index) => updatePreview(index));
    }

    // Add new section
    function addSection() {
      sections.push({
        name: "New Section",
        content: "Enter content here..."
      });
      renderSections();
      parseEmojis();
    }

    // Remove section
    function removeSection(index) {
      if (sections.length > 1 && confirm('Remove this section?')) {
        sections.splice(index, 1);
        renderSections();
        parseEmojis();
      } else if (sections.length === 1) {
        showError('Cannot remove the last section');
      }
    }

    // Save prompt
    async function savePrompt() {
      const statusDiv = document.getElementById('save-status');
      statusDiv.innerHTML = '<div class="status-loading">üíæ Saving prompt configuration...</div>';

      try {
        await window.HanuAPI.updateSystemPrompt(sections);
        statusDiv.innerHTML = '<div class="status-success">‚úÖ System prompt saved successfully!</div>';
        
        // Clear status after 3 seconds
        setTimeout(() => {
          statusDiv.innerHTML = '';
        }, 3000);
        
        parseEmojis();

      } catch (error) {
        statusDiv.innerHTML = `<div class="status-error">‚ùå Save failed: ${error.message}</div>`;
        parseEmojis();
      }
    }

    // Export prompt configuration
    function exportPrompt() {
      const config = {
        sections: sections,
        timestamp: new Date().toISOString(),
        version: "1.0"
      };
      
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hanu-prompts-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showSuccess('Prompt configuration exported successfully');
    }

    // Test prompt with sample content
    async function testPrompt() {
      const testContent = document.getElementById('test-content').value.trim();
      const resultsDiv = document.getElementById('test-results');

      if (!testContent) {
        showError('Please enter some test content first');
        return;
      }

      resultsDiv.innerHTML = '<div class="test-result"><h4>‚è≥ Testing prompt with AI...</h4></div>';

      try {
        const response = await window.HanuAPI.testPrompt(testContent);
        
        resultsDiv.innerHTML = `
          <div class="test-result">
            <h4>ü§ñ AI Response:</h4>
            <div class="test-result-content">${response.result || 'No response received'}</div>
            <small style="color: #72767d;">Generated: ${new Date().toLocaleString()}</small>
          </div>
        `;
        
        parseEmojis();

      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="test-result" style="border-left-color: #ed4245;">
            <h4>‚ùå Test Failed:</h4>
            <div class="test-result-content">${error.message}</div>
          </div>
        `;
        parseEmojis();
      }
    }

    // Clear test results
    function clearTest() {
      document.getElementById('test-content').value = '';
      document.getElementById('test-results').innerHTML = '';
    }

    // Utility functions
    function showSuccess(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: #3ba55d; color: white; padding: 12px 20px;
        border-radius: 6px; font-weight: 600; font-size: 14px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function showError(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: #ed4245; color: white; padding: 12px 20px;
        border-radius: 6px; font-weight: 600; font-size: 14px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Discord-style emoji rendering
    function parseEmojis() {
      if (typeof twemoji !== 'undefined') {
        twemoji.parse(document.body, {
          folder: 'svg',
          ext: '.svg'
        });
      }
    }

    // Initialize emoji parsing when DOM loads
    document.addEventListener('DOMContentLoaded', parseEmojis);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Prompt Editor loaded');
    });
  </script>
</body>
</html>
