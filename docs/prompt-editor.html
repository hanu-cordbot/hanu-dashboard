<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Prompt Editor</title>
  <link href="shared/common.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <style>
    .editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 80vh; }
    .editor-panel { display: flex; flex-direction: column; }
    .editor-textarea { flex: 1; min-height: 200px; font-family: 'Courier New', monospace; font-size: 14px; }
    .preview-panel { background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-y: auto; }
    .test-controls { background: #e9ecef; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
    .prompt-section { background: white; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 15px; }
    .prompt-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #dee2e6; font-weight: 600; }
    .prompt-content { padding: 15px; }
    .test-entry { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 10px 0; }
    .ai-response { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 10px 0; white-space: pre-wrap; }
    .discord-preview { background: #36393f; color: #dcddde; padding: 15px; border-radius: 6px; font-family: Whitney, "Helvetica Neue", Helvetica, Arial, sans-serif; }
    .message-content { background: #40444b; padding: 10px; border-radius: 4px; margin: 5px 0; }
    .loading-dots { animation: loading 1.5s infinite; }
    @keyframes loading { 0%, 80%, 100% { opacity: 0.6; } 40% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">üè† Home</a>
      <a href="dashboard.html">ü§ñ Dashboard</a>
      <a href="prompt-editor.html" class="active">‚úèÔ∏è Prompt Editor</a>
      <a href="stats.html">üìä Statistics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>‚úèÔ∏è Prompt Editor & Tester</h1>
      <p>Edit AI prompts and test Discord posting with real RSS entries</p>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>üîê Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button id="login-button">Login</button>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Test Controls -->
      <div class="test-controls">
        <h3>üß™ Testing Controls</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Feed to Test:</label>
            <select id="test-feed" onchange="loadFeedEntries()">
              <option value="">Select a feed...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Recent Entry:</label>
            <select id="test-entry">
              <option value="">Select an entry...</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Target Channel:</label>
            <select id="target-channel">
              <option value="">Select channel...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Test Mode:</label>
            <select id="test-mode">
              <option value="preview">Preview Only</option>
              <option value="discord">Send to Discord</option>
            </select>
          </div>
        </div>
        
        <div class="flex gap-15">
          <button onclick="testPrompt()" class="btn btn-primary" id="test-btn">üß™ Test Prompt</button>
          <button onclick="loadPrompt()" class="btn btn-secondary">üì• Load Current</button>
          <button onclick="savePrompt()" class="btn btn-success">üíæ Save Prompt</button>
          <button onclick="resetPrompt()" class="btn btn-outline">üîÑ Reset</button>
        </div>
      </div>

      <!-- Editor Container -->
      <div class="editor-container">
        <!-- Left Panel: Prompt Editor -->
        <div class="editor-panel">
          <h3>üìù Prompt Configuration</h3>
          
          <div class="prompt-section">
            <div class="prompt-header">
              ü§ñ System Role
              <button onclick="toggleSection('system')" class="btn btn-outline" style="float: right; font-size: 12px;">‚ñº</button>
            </div>
            <div class="prompt-content" id="system-content">
              <textarea class="editor-textarea" id="system-prompt" placeholder="Define the AI's role and behavior...">You are a text formatter for HANU University. Transform RSS feed content into engaging Discord posts in Vietnamese.</textarea>
            </div>
          </div>

          <div class="prompt-section">
            <div class="prompt-header">
              üé® Formatting Rules
              <button onclick="toggleSection('formatting')" class="btn btn-outline" style="float: right; font-size: 12px;">‚ñº</button>
            </div>
            <div class="prompt-content" id="formatting-content">
              <textarea class="editor-textarea" id="formatting-prompt" placeholder="Define formatting rules...">**FORMATTING RULES:**
- Use `**bold**` for main headings
- Use `*italics*` for emphasis  
- Use `> ` for blockquotes
- Preserve all original emojis
- Remove hashtag walls but keep links
- Wrap links with &lt;&gt;</textarea>
            </div>
          </div>

          <div class="prompt-section">
            <div class="prompt-header">
              üìã Output Template
              <button onclick="toggleSection('template')" class="btn btn-outline" style="float: right; font-size: 12px;">‚ñº</button>
            </div>
            <div class="prompt-content" id="template-content">
              <textarea class="editor-textarea" id="template-prompt" placeholder="Define output structure...">&lt;MARKDOWN_FORMATTED_BODY&gt;

-# tl;dr:
-# &lt;summary sentence 1&gt;
-# &lt;summary sentence 2&gt;</textarea>
            </div>
          </div>
        </div>

        <!-- Right Panel: Preview & Testing -->
        <div class="editor-panel">
          <h3>üëÅÔ∏è Preview & Testing</h3>
          
          <!-- Test Entry Display -->
          <div class="prompt-section">
            <div class="prompt-header">üì∞ Test Entry</div>
            <div class="prompt-content">
              <div id="test-entry-display" class="test-entry">
                Select a feed and entry to test with...
              </div>
            </div>
          </div>

          <!-- AI Response -->
          <div class="prompt-section">
            <div class="prompt-header">ü§ñ AI Response</div>
            <div class="prompt-content">
              <div id="ai-response" class="ai-response">
                Click "Test Prompt" to see AI-generated response...
              </div>
            </div>
          </div>

          <!-- Discord Preview -->
          <div class="prompt-section">
            <div class="prompt-header">üí¨ Discord Preview</div>
            <div class="prompt-content">
              <div id="discord-preview" class="discord-preview">
                <div class="message-content">
                  AI response will be previewed here as it would appear in Discord...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import HanuAuth from './shared/auth.js';
    import HanuAPI from './shared/api.js';

    let feeds = [];
    let channels = [];
    let currentEntries = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      HanuAuth.setupAuthUI();
      
      HanuAuth.onLogin(async () => {
        await loadData();
      });
      
      if (HanuAuth.isAuthenticated()) {
        const isValid = await HanuAuth.testAuth();
        if (isValid) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          await loadData();
        }
      }
      
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
    });

    // Load feeds and channels
    async function loadData() {
      try {
        const [feedsData, channelsData] = await Promise.all([
          HanuAPI.getFeeds(),
          HanuAPI.getChannels()
        ]);

        feeds = feedsData.feeds || [];
        channels = channelsData.channels || [];

        // Populate feed dropdown
        const feedSelect = document.getElementById('test-feed');
        feedSelect.innerHTML = '<option value="">Select a feed...</option>';
        feeds.forEach(feed => {
          const title = feedsData.metadata?.[feed.url]?.title || feed.url.substring(0, 50) + '...';
          feedSelect.innerHTML += `<option value="${feed.url}">${title}</option>`;
        });

        // Populate channel dropdown
        const channelSelect = document.getElementById('target-channel');
        channelSelect.innerHTML = '<option value="">Select channel...</option>';
        channels.forEach(channel => {
          const emoji = channel.type === 'forum' ? 'üí¨' : (channel.type === 'voice' ? 'üîä' : 'üìù');
          channelSelect.innerHTML += `<option value="${channel.id}">${emoji} ${channel.name}</option>`;
        });

      } catch (error) {
        console.error('Failed to load data:', error);
        showAlert('Failed to load data: ' + error.message, 'danger');
      }
    }

    // Load entries for selected feed
    window.loadFeedEntries = async function() {
      const feedUrl = document.getElementById('test-feed').value;
      if (!feedUrl) return;

      try {
        showAlert('Loading recent entries...', 'info');
        
        // Call your RSS parser or use a test endpoint
        const response = await fetch(`https://web-production-b0a5.up.railway.app/test-entries?feed=${encodeURIComponent(feedUrl)}`, {
          headers: { 'X-Auth': HanuAuth.getToken() }
        });
        
        const entries = await response.json();
        currentEntries = entries.slice(0, 10); // Last 10 entries

        const entrySelect = document.getElementById('test-entry');
        entrySelect.innerHTML = '<option value="">Select an entry...</option>';
        
        currentEntries.forEach((entry, index) => {
          const title = entry.title?.substring(0, 50) + '...' || `Entry ${index + 1}`;
          entrySelect.innerHTML += `<option value="${index}">${title}</option>`;
        });

      } catch (error) {
        console.error('Failed to load entries:', error);
        showAlert('Failed to load entries. Using mock data.', 'warning');
        
        // Fallback to mock data
        currentEntries = [{
          title: 'Test Entry from ' + feedUrl.split('/')[2],
          content: 'This is a sample RSS entry for testing purposes. It contains some text that would normally come from the RSS feed.',
          link: feedUrl,
          published: new Date().toISOString()
        }];
        
        document.getElementById('test-entry').innerHTML = 
          '<option value="">Select an entry...</option><option value="0">Sample Test Entry</option>';
      }
    };

    // Test the prompt with selected entry
    window.testPrompt = async function() {
      const entryIndex = document.getElementById('test-entry').value;
      const channelId = document.getElementById('target-channel').value;
      const testMode = document.getElementById('test-mode').value;
      
      if (!entryIndex || !channelId) {
        showAlert('Please select both an entry and a target channel', 'warning');
        return;
      }

      const entry = currentEntries[parseInt(entryIndex)];
      const button = document.getElementById('test-btn');
      
      button.disabled = true;
      button.innerHTML = '<span class="loading-dots">üß™ Testing...</span>';

      try {
        // Display the test entry
        document.getElementById('test-entry-display').innerHTML = `
          <h4>${entry.title}</h4>
          <p>${entry.content || 'No content preview available'}</p>
          <small>Published: ${new Date(entry.published).toLocaleString()}</small>
        `;

        // Build the prompt
        const systemPrompt = document.getElementById('system-prompt').value;
        const formattingPrompt = document.getElementById('formatting-prompt').value;
        const templatePrompt = document.getElementById('template-prompt').value;
        
        const fullPrompt = `${systemPrompt}\n\n${formattingPrompt}\n\n${templatePrompt}\n\nPOST TITLE: ${entry.title}\nPOST BODY:\n${entry.content}`;

        // Test with Gemini API
        const aiResponse = await testWithGemini(fullPrompt);
        
        // Display AI response
        document.getElementById('ai-response').textContent = aiResponse;

        // Create Discord preview
        const discordPreview = formatForDiscord(aiResponse);
        document.getElementById('discord-preview').innerHTML = discordPreview;

        // If test mode is Discord, actually send it
        if (testMode === 'discord') {
          await sendToDiscord(channelId, entry, aiResponse);
        }

      } catch (error) {
        console.error('Test failed:', error);
        showAlert('Test failed: ' + error.message, 'danger');
        document.getElementById('ai-response').textContent = 'Error: ' + error.message;
      } finally {
        button.disabled = false;
        button.innerHTML = 'üß™ Test Prompt';
      }
    };

    // Test with Gemini API
    async function testWithGemini(prompt) {
      try {
        const response = await fetch(`https://web-production-b0a5.up.railway.app/test-gemini`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth': HanuAuth.getToken()
          },
          body: JSON.stringify({ prompt })
        });

        const result = await response.json();
        
        if (result.success) {
          return result.response;
        } else {
          throw new Error(result.error || 'Gemini API failed');
        }
      } catch (error) {
        // Fallback response
        return `**ü§ñ AI Response (Fallback)**

This is a formatted response for the test entry. The actual AI would process the content and return a properly formatted Discord message.

-# tl;dr:
-# This is a test summary
-# Generated from the prompt editor`;
      }
    }

    // Format AI response for Discord preview
    function formatForDiscord(response) {
      // Convert markdown to Discord-style preview
      let formatted = response
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^-# (.*$)/gim, '<small style="color: #72767d;">$1</small>');

      return `
        <div class="message-content">
          <div style="color: #00b0f4; font-weight: 600; margin-bottom: 5px;">HANU Bot</div>
          <div style="white-space: pre-wrap;">${formatted}</div>
        </div>
      `;
    }

    // Send to actual Discord channel
    async function sendToDiscord(channelId, entry, aiResponse) {
      try {
        showAlert('Sending to Discord...', 'info');
        
        const response = await fetch(`https://web-production-b0a5.up.railway.app/test-discord`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth': HanuAuth.getToken()
          },
          body: JSON.stringify({
            channel_id: channelId,
            content: aiResponse,
            entry: entry
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert('‚úÖ Message sent to Discord successfully!', 'success');
        } else {
          throw new Error(result.error || 'Failed to send to Discord');
        }
      } catch (error) {
        console.error('Discord send failed:', error);
        showAlert('Failed to send to Discord: ' + error.message, 'danger');
      }
    }

    // Load current prompt from system
    window.loadPrompt = async function() {
      try {
        const prompt = await HanuAPI.getSystemPrompt();
        
        if (prompt.sections && prompt.sections.length > 0) {
          prompt.sections.forEach(section => {
            const name = section.name.toLowerCase();
            if (name.includes('system') || name.includes('role')) {
              document.getElementById('system-prompt').value = section.content;
            } else if (name.includes('format')) {
              document.getElementById('formatting-prompt').value = section.content;
            } else if (name.includes('template') || name.includes('output')) {
              document.getElementById('template-prompt').value = section.content;
            }
          });
          
          showAlert('Current prompt loaded!', 'success');
        }
      } catch (error) {
        showAlert('Failed to load current prompt: ' + error.message, 'warning');
      }
    };

    // Save prompt to system
    window.savePrompt = async function() {
      try {
        const sections = [
          {
            name: 'System Role',
            content: document.getElementById('system-prompt').value
          },
          {
            name: 'Formatting Rules', 
            content: document.getElementById('formatting-prompt').value
          },
          {
            name: 'Output Template',
            content: document.getElementById('template-prompt').value
          }
        ];

        await HanuAPI.updateSystemPrompt({ sections });
        showAlert('Prompt saved successfully! üíæ', 'success');
      } catch (error) {
        showAlert('Failed to save prompt: ' + error.message, 'danger');
      }
    };

    // Reset to default prompt
    window.resetPrompt = function() {
      if (!confirm('Reset to default prompt? This will lose current changes.')) return;
      
      document.getElementById('system-prompt').value = 'You are a text formatter for HANU University. Transform RSS feed content into engaging Discord posts in Vietnamese.';
      document.getElementById('formatting-prompt').value = '**FORMATTING RULES:**\n- Use `**bold**` for main headings\n- Use `*italics*` for emphasis\n- Use `> ` for blockquotes\n- Preserve all original emojis\n- Remove hashtag walls but keep links\n- Wrap links with <>';
      document.getElementById('template-prompt').value = '<MARKDOWN_FORMATTED_BODY>\n\n-# tl;dr:\n-# <summary sentence 1>\n-# <summary sentence 2>';
      
      showAlert('Prompt reset to defaults', 'info');
    };

    // Toggle section visibility
    window.toggleSection = function(sectionId) {
      const content = document.getElementById(`${sectionId}-content`);
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      
      const button = content.previousElementSibling.querySelector('button');
      button.textContent = isHidden ? '‚ñº' : '‚ñ∂';
    };

    // Alert helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fade-in`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      alertDiv.textContent = message;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => alertDiv.remove(), 5000);
    }
  </script>
</body>
</html>
