<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HANU Prompt Editor</title>
  <link href="shared/common.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .test-config {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
    }
    
    .test-config h4 {
      margin: 0 0 15px 0;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 8px;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .config-section {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    
    .config-section h5 {
      margin: 0 0 10px 0;
      color: #6c757d;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .feed-channel-selector {
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px;
      background: #fafafa;
    }
    
    .feed-channel-item {
      display: flex;
      align-items: center;
      padding: 4px 0;
      font-size: 13px;
    }
    
    .feed-channel-item input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .feed-channel-item label {
      flex: 1;
      cursor: pointer;
      color: #495057;
    }
    
    .test-results-grid {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .test-result-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
    }
    
    .test-result-item.success {
      border-left: 4px solid #28a745;
    }
    
    .test-result-item.error {
      border-left: 4px solid #dc3545;
    }
    
    .test-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      color: #6c757d;
    }
    
    .test-content {
      background: white;
      padding: 12px;
      border-radius: 4px;
      margin: 10px 0;
      white-space: pre-wrap;
      font-family: 'Segoe UI', system-ui, sans-serif;
      line-height: 1.4;
    }
    
    .config-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .slider-container input[type="range"] {
      flex: 1;
      min-width: 100px;
    }
    
    .slider-value {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
      color: #495057;
    }
    
    .quick-select {
      display: flex;
      gap: 5px;
      margin-top: 8px;
    }
    
    .quick-select button {
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #dee2e6;
      background: #f8f9fa;
      color: #495057;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .quick-select button:hover {
      background: #e9ecef;
    }
    
    .test-progress {
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .test-progress-bar {
      background: #007bff;
      height: 6px;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a href="index.html">ğŸ  Home</a>
      <a href="dashboard.html">ğŸ¤– Dashboard</a>
      <a href="prompt-editor.html" class="active">âœï¸ Prompt Editor</a>
      <a href="stats.html">ğŸ“Š Statistics</a>
      <a href="analytics.html">ğŸ“ˆ Analytics</a>
    </div>

    <!-- Header -->
    <div class="header">
      <h1>âœï¸ System Prompt Editor</h1>
      <p>Configure AI system prompts that control how the bot processes RSS feeds</p>
    </div>

    <!-- Authentication -->
    <div class="auth-section" id="auth-section">
      <h3>ğŸ” Authentication Required</h3>
      <input type="password" id="auth-token" placeholder="Enter AUTH_TOKEN">
      <button id="login-button">Login</button>
      <div id="auth-status" style="margin-top: 10px;"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
      <!-- Current Prompt Status -->
      <div class="status-grid">
        <div class="status-card">
          <strong>ğŸ“ Prompt Sections</strong>
          <div class="status-value" id="sections-count">0</div>
        </div>
        <div class="status-card">
          <strong>ğŸ“Š Total Length</strong>
          <div class="status-value" id="total-length">0</div>
        </div>
        <div class="status-card">
          <strong>ğŸ’¾ Last Saved</strong>
          <div class="status-value" id="last-saved">Never</div>
        </div>
      </div>

      <!-- Prompt Sections -->
      <div class="section">
        <div class="flex-between mb-20">
          <h2>ğŸ“‹ Prompt Sections</h2>
          <div>
            <button onclick="addSection()" class="btn btn-primary">â• Add Section</button>
            <button onclick="savePrompt()" class="btn btn-success" id="save-btn">ğŸ’¾ Save Prompt</button>
          </div>
        </div>

        <div id="sections-container">
          <div class="loading">Loading prompt sections...</div>
        </div>
      </div>

      <!-- Basic Prompt Testing -->
      <div class="section">
        <h2>ğŸ§ª Basic Prompt Testing</h2>
        <p>Test your prompt with manual RSS feed content</p>
        
        <div class="form-group mb-15">
          <textarea id="test-content" rows="6" placeholder="Paste sample RSS feed content here for testing...">
TiÃªu Ä‘á»: CLB Thanh niÃªn váº­n Ä‘á»™ng hiáº¿n mÃ¡u thÃ´ng bÃ¡o
Ná»™i dung: ThÃ´ng bÃ¡o Ä‘áº¿n cÃ¡c báº¡n sinh viÃªn vá» chÆ°Æ¡ng trÃ¬nh hiáº¿n mÃ¡u nhÃ¢n Ä‘áº¡o sáº½ Ä‘Æ°á»£c tá»• chá»©c vÃ o ngÃ y 25/7/2025 táº¡i há»™i trÆ°á»ng A1. Má»i cÃ¡c báº¡n tham gia á»§ng há»™ hoáº¡t Ä‘á»™ng Ã½ nghÄ©a nÃ y.
Link: https://www.facebook.com/doimauhanu/posts/1298142858987694
NgÃ y Ä‘Äƒng: 2025-07-21T08:00:00
          </textarea>
        </div>

        <div class="flex gap-15 mb-15">
          <button onclick="testPrompt()" class="btn btn-primary" id="test-btn">ğŸš€ Test with AI</button>
          <button onclick="clearTest()" class="btn btn-secondary">ğŸ—‘ï¸ Clear</button>
          <button onclick="loadSampleContent()" class="btn btn-outline">ğŸ“„ Load Sample</button>
        </div>

        <div id="test-results"></div>
      </div>

      <!-- Advanced Random Testing -->
      <div class="section">
        <h2>ğŸ² Advanced Random Testing</h2>
        <p>Test your prompt with random feeds and channels from your actual system</p>
        
        <div class="test-config">
          <h4>ğŸ”§ Test Configuration</h4>
          
          <div class="config-grid">
            <!-- Test Parameters -->
            <div class="config-section">
              <h5>ğŸ“Š Test Parameters</h5>
              
              <div class="form-group">
                <label>Number of Tests:</label>
                <div class="slider-container">
                  <input type="range" id="post-count" min="1" max="10" value="3" oninput="updateSliderValue('post-count', 'post-count-value')">
                  <span class="slider-value" id="post-count-value">3</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>
                  <input type="checkbox" id="include-media"> Include Media Content
                </label>
              </div>
              
              <div class="form-group">
                <label>Test Type:</label>
                <select id="test-type" class="w-full">
                  <option value="random">Random Selection</option>
                  <option value="recent">Recent Posts Only</option>
                  <option value="popular">Popular Feeds Only</option>
                  <option value="mixed">Mixed Strategy</option>
                </select>
              </div>
            </div>

            <!-- Feed Selection -->
            <div class="config-section">
              <h5>ğŸ“° Feed Pool</h5>
              
              <div class="quick-select">
                <button onclick="selectAllFeeds()">All</button>
                <button onclick="selectActiveFeeds()">Active Only</button>
                <button onclick="selectMappedFeeds()">Mapped Only</button>
                <button onclick="clearFeedSelection()">None</button>
              </div>
              
              <div class="feed-channel-selector" id="feed-selector">
                <div class="loading">Loading feeds...</div>
              </div>
              
              <small class="text-muted">
                <span id="selected-feeds-count">0</span> feeds selected
              </small>
            </div>

            <!-- Channel Selection -->
            <div class="config-section">
              <h5>ğŸ“º Channel Pool</h5>
              
              <div class="quick-select">
                <button onclick="selectAllChannels()">All</button>
                <button onclick="selectTextChannels()">Text Only</button>
                <button onclick="selectForumChannels()">Forum Only</button>
                <button onclick="clearChannelSelection()">None</button>
              </div>
              
              <div class="feed-channel-selector" id="channel-selector">
                <div class="loading">Loading channels...</div>
              </div>
              
              <small class="text-muted">
                <span id="selected-channels-count">0</span> channels selected
              </small>
            </div>

            <!-- Exclusions -->
            <div class="config-section">
              <h5>ğŸš« Exclusions</h5>
              
              <div class="form-group">
                <label>Exclude Feeds:</label>
                <div class="feed-channel-selector" id="exclude-feeds-selector">
                  <div class="loading">Loading feeds...</div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Exclude Channels:</label>
                <div class="feed-channel-selector" id="exclude-channels-selector">
                  <div class="loading">Loading channels...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Controls -->
          <div class="config-controls mt-20">
            <button onclick="runRandomTests()" class="btn btn-primary" id="random-test-btn">
              ğŸ² Run Random Tests
            </button>
            <button onclick="clearRandomResults()" class="btn btn-secondary">
              ğŸ—‘ï¸ Clear Results
            </button>
            <button onclick="saveTestConfig()" class="btn btn-outline">
              ğŸ’¾ Save Config
            </button>
            <button onclick="loadTestConfig()" class="btn btn-outline">
              ğŸ“‚ Load Config
            </button>
          </div>
          
          <div id="test-progress" class="test-progress" style="display: none;">
            <div id="test-progress-bar" class="test-progress-bar"></div>
          </div>
        </div>

        <!-- Random Test Results -->
        <div id="random-test-results"></div>
      </div>

      <!-- Prompt Templates -->
      <div class="section">
        <h2>ğŸ“š Prompt Templates</h2>
        <p>Quick-start templates for different use cases</p>
        
        <div class="flex gap-15">
          <button onclick="loadTemplate('vietnamese')" class="btn btn-outline">ğŸ‡»ğŸ‡³ Vietnamese University</button>
          <button onclick="loadTemplate('general')" class="btn btn-outline">ğŸŒ General RSS Bot</button>
          <button onclick="loadTemplate('minimal')" class="btn btn-outline">âš¡ Minimal</button>
          <button onclick="loadTemplate('detailed')" class="btn btn-outline">ğŸ“– Detailed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import HanuAuth from './shared/auth.js';
    import HanuAPI from './shared/api.js';

    let sections = [];
    let lastSavedTime = null;
    let availableFeeds = [];
    let availableChannels = [];
    let testConfig = {
      feedPool: [],
      channelPool: [],
      excludeFeeds: [],
      excludeChannels: [],
      postCount: 3,
      includeMedia: false,
      testType: 'random'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      HanuAuth.setupAuthUI();
      
      HanuAuth.onLogin(async () => {
        await loadPrompt();
        await loadFeedsAndChannels();
        loadTestConfig();
      });
      
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
      
      if (HanuAuth.isAuthenticated()) {
        const isValid = await HanuAuth.testAuth();
        if (isValid) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('main-content').classList.remove('hidden');
          await loadPrompt();
          await loadFeedsAndChannels();
          loadTestConfig();
        }
      }
    });

    // Load feeds and channels for random testing
    async function loadFeedsAndChannels() {
      try {
        const [feedsData, channelsData] = await Promise.all([
          HanuAPI.getFeeds(),
          HanuAPI.getChannels()
        ]);
        
        availableFeeds = feedsData.feeds || [];
        availableChannels = channelsData.channels || [];
        
        renderFeedChannelSelectors();
        updateSelectionCounts();
        
      } catch (error) {
        console.error('Failed to load feeds/channels:', error);
        showAlert('Failed to load feeds and channels for testing', 'warning');
      }
    }

    // Render feed and channel selectors
    function renderFeedChannelSelectors() {
      // Main feed selector
      const feedSelector = document.getElementById('feed-selector');
      let feedHtml = '';
      availableFeeds.forEach(feed => {
        const checked = testConfig.feedPool.includes(feed.url) ? 'checked' : '';
        feedHtml += `
          <div class="feed-channel-item">
            <input type="checkbox" id="feed-${feed.url}" ${checked} 
                   onchange="toggleFeedSelection('${feed.url}')">
            <label for="feed-${feed.url}">${feed.title}</label>
          </div>
        `;
      });
      feedSelector.innerHTML = feedHtml || '<div class="text-muted">No feeds available</div>';

      // Main channel selector
      const channelSelector = document.getElementById('channel-selector');
      let channelHtml = '';
      availableChannels.forEach(channel => {
        const checked = testConfig.channelPool.includes(channel.id) ? 'checked' : '';
        const emoji = channel.type === 'forum' ? 'ğŸ’¬' : (channel.type === 'voice' ? 'ğŸ”Š' : 'ğŸ“');
        channelHtml += `
          <div class="feed-channel-item">
            <input type="checkbox" id="channel-${channel.id}" ${checked} 
                   onchange="toggleChannelSelection('${channel.id}')">
            <label for="channel-${channel.id}">${emoji} ${channel.name}</label>
          </div>
        `;
      });
      channelSelector.innerHTML = channelHtml || '<div class="text-muted">No channels available</div>';

      // Exclude feeds selector
      const excludeFeedsSelector = document.getElementById('exclude-feeds-selector');
      let excludeFeedHtml = '';
      availableFeeds.forEach(feed => {
        const checked = testConfig.excludeFeeds.includes(feed.url) ? 'checked' : '';
        excludeFeedHtml += `
          <div class="feed-channel-item">
            <input type="checkbox" id="exclude-feed-${feed.url}" ${checked} 
                   onchange="toggleExcludeFeed('${feed.url}')">
            <label for="exclude-feed-${feed.url}">${feed.title}</label>
          </div>
        `;
      });
      excludeFeedsSelector.innerHTML = excludeFeedHtml || '<div class="text-muted">No feeds to exclude</div>';

      // Exclude channels selector
      const excludeChannelsSelector = document.getElementById('exclude-channels-selector');
      let excludeChannelHtml = '';
      availableChannels.forEach(channel => {
        const checked = testConfig.excludeChannels.includes(channel.id) ? 'checked' : '';
        const emoji = channel.type === 'forum' ? 'ğŸ’¬' : (channel.type === 'voice' ? 'ğŸ”Š' : 'ğŸ“');
        excludeChannelHtml += `
          <div class="feed-channel-item">
            <input type="checkbox" id="exclude-channel-${channel.id}" ${checked} 
                   onchange="toggleExcludeChannel('${channel.id}')">
            <label for="exclude-channel-${channel.id}">${emoji} ${channel.name}</label>
          </div>
        `;
      });
      excludeChannelsSelector.innerHTML = excludeChannelHtml || '<div class="text-muted">No channels to exclude</div>';
    }

    // Toggle selections
    window.toggleFeedSelection = function(feedUrl) {
      const index = testConfig.feedPool.indexOf(feedUrl);
      if (index > -1) {
        testConfig.feedPool.splice(index, 1);
      } else {
        testConfig.feedPool.push(feedUrl);
      }
      updateSelectionCounts();
    };

    window.toggleChannelSelection = function(channelId) {
      const index = testConfig.channelPool.indexOf(channelId);
      if (index > -1) {
        testConfig.channelPool.splice(index, 1);
      } else {
        testConfig.channelPool.push(channelId);
      }
      updateSelectionCounts();
    };

    window.toggleExcludeFeed = function(feedUrl) {
      const index = testConfig.excludeFeeds.indexOf(feedUrl);
      if (index > -1) {
        testConfig.excludeFeeds.splice(index, 1);
      } else {
        testConfig.excludeFeeds.push(feedUrl);
      }
    };

    window.toggleExcludeChannel = function(channelId) {
      const index = testConfig.excludeChannels.indexOf(channelId);
      if (index > -1) {
        testConfig.excludeChannels.splice(index, 1);
      } else {
        testConfig.excludeChannels.push(channelId);
      }
    };

    // Quick selection functions
    window.selectAllFeeds = function() {
      testConfig.feedPool = availableFeeds.map(f => f.url);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.selectActiveFeeds = function() {
      const activeFeeds = availableFeeds.filter(f => f.lastPost && 
        (Date.now() - new Date(f.lastPost)) < (14 * 24 * 60 * 60 * 1000));
      testConfig.feedPool = activeFeeds.map(f => f.url);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.selectMappedFeeds = function() {
      // This would need mapping data - simplified for now
      testConfig.feedPool = availableFeeds.slice(0, Math.ceil(availableFeeds.length / 2)).map(f => f.url);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.clearFeedSelection = function() {
      testConfig.feedPool = [];
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.selectAllChannels = function() {
      testConfig.channelPool = availableChannels.map(c => c.id);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.selectTextChannels = function() {
      const textChannels = availableChannels.filter(c => c.type === 'text');
      testConfig.channelPool = textChannels.map(c => c.id);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.selectForumChannels = function() {
      const forumChannels = availableChannels.filter(c => c.type === 'forum');
      testConfig.channelPool = forumChannels.map(c => c.id);
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    window.clearChannelSelection = function() {
      testConfig.channelPool = [];
      renderFeedChannelSelectors();
      updateSelectionCounts();
    };

    // Update selection counts
    function updateSelectionCounts() {
      document.getElementById('selected-feeds-count').textContent = testConfig.feedPool.length;
      document.getElementById('selected-channels-count').textContent = testConfig.channelPool.length;
    }

    // Update slider values
    window.updateSliderValue = function(sliderId, valueId) {
      const slider = document.getElementById(sliderId);
      const valueSpan = document.getElementById(valueId);
      valueSpan.textContent = slider.value;
      
      if (sliderId === 'post-count') {
        testConfig.postCount = parseInt(slider.value);
      }
    };

    // Run random tests
    window.runRandomTests = async function() {
      const button = document.getElementById('random-test-btn');
      const progressContainer = document.getElementById('test-progress');
      const progressBar = document.getElementById('test-progress-bar');
      const resultsContainer = document.getElementById('random-test-results');

      // Update config from UI
      testConfig.postCount = parseInt(document.getElementById('post-count').value);
      testConfig.includeMedia = document.getElementById('include-media').checked;
      testConfig.testType = document.getElementById('test-type').value;

      // Validation
      if (testConfig.feedPool.length === 0 || testConfig.channelPool.length === 0) {
        showAlert('Please select at least one feed and one channel for testing', 'warning');
        return;
      }

      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Running Tests...';
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      try {
        // Show initial progress
        progressBar.style.width = '10%';
        
        resultsContainer.innerHTML = `
          <div class="test-result-item">
            <h3>ğŸ² Initializing Random Tests...</h3>
            <p>Configuration: ${testConfig.postCount} tests, ${testConfig.feedPool.length} feeds, ${testConfig.channelPool.length} channels</p>
          </div>
        `;

        // Call the API
        const response = await HanuAPI.testRandomPrompt(testConfig);
        progressBar.style.width = '100%';

        // Display results
        displayRandomTestResults(response);
        
        showAlert(`Random testing completed! Generated ${response.results?.length || 0} test cases ğŸ‰`, 'success');

      } catch (error) {
        console.error('Random test failed:', error);
        resultsContainer.innerHTML = `
          <div class="test-result-item error">
            <h3>âŒ Random Test Failed</h3>
            <p style="color: #dc3545;">${error.message}</p>
          </div>
        `;
        showAlert('Random testing failed: ' + error.message, 'danger');
      } finally {
        button.disabled = false;
        button.innerHTML = 'ğŸ² Run Random Tests';
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 1000);
      }
    };

    // Display random test results
    function displayRandomTestResults(response) {
      const resultsContainer = document.getElementById('random-test-results');
      
      if (!response.results || response.results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="test-result-item">
            <h3>âš ï¸ No Test Results</h3>
            <p>No test cases were generated. Check your configuration.</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="test-result-item success">
          <h3>ğŸ‰ Random Test Results</h3>
          <div class="test-meta">
            <span>Tests: ${response.results.length}</span>
            <span>Available Feeds: ${response.available?.feeds || 0}</span>
            <span>Available Channels: ${response.available?.channels || 0}</span>
            <span>Generated: ${new Date().toLocaleString()}</span>
          </div>
        </div>
        
        <div class="test-results-grid">
      `;

      response.results.forEach((result, index) => {
        const statusClass = result.status === 'success' ? 'success' : 'error';
        html += `
          <div class="test-result-item ${statusClass}">
            <div class="test-meta">
              <span><strong>Test ${index + 1}</strong></span>
              <span>Feed: ${result.feed_url?.split('/').pop() || 'Unknown'}</span>
              <span>Channel: #${result.channel_name || 'Unknown'}</span>
              ${result.processing_time ? `<span>Time: ${result.processing_time}ms</span>` : ''}
            </div>
            
            <h4>${result.title}</h4>
            
            ${result.status === 'success' ? `
              <div class="test-content">${result.ai_response || 'No AI response'}</div>
            ` : `
              <div style="color: #dc3545; padding: 10px;">
                <strong>Error:</strong> ${result.error || 'Unknown error'}
              </div>
            `}
            
            <details style="margin-top: 10px;">
              <summary style="cursor: pointer; color: #6c757d;">Show Test Data</summary>
              <div class="test-content" style="margin-top: 8px; font-size: 12px;">
                <strong>Original Content:</strong><br>
                ${result.content}
                <br><br>
                <strong>Configuration:</strong><br>
                Channel Type: ${result.channel_name} (${result.channel_id})<br>
                Has Media: ${result.has_media ? 'Yes' : 'No'}<br>
                Timestamp: ${result.timestamp}
              </div>
            </details>
          </div>
        `;
      });

      html += '</div>';
      resultsContainer.innerHTML = html;
      twemoji.parse(resultsContainer, { folder: 'svg', ext: '.svg' });
    }

    // Clear random results
    window.clearRandomResults = function() {
      document.getElementById('random-test-results').innerHTML = '';
    };

    // Save/Load test configuration
    window.saveTestConfig = function() {
      try {
        localStorage.setItem('hanu-test-config', JSON.stringify(testConfig));
        showAlert('Test configuration saved! ğŸ’¾', 'success');
      } catch (error) {
        showAlert('Failed to save configuration', 'warning');
      }
    };

    window.loadTestConfig = function() {
      try {
        const saved = localStorage.getItem('hanu-test-config');
        if (saved) {
          testConfig = { ...testConfig, ...JSON.parse(saved) };
          
          // Update UI
          document.getElementById('post-count').value = testConfig.postCount;
          document.getElementById('post-count-value').textContent = testConfig.postCount;
          document.getElementById('include-media').checked = testConfig.includeMedia;
          document.getElementById('test-type').value = testConfig.testType;
          
          renderFeedChannelSelectors();
          updateSelectionCounts();
          showAlert('Test configuration loaded! ğŸ“‚', 'success');
        } else {
          showAlert('No saved configuration found', 'info');
        }
      } catch (error) {
        showAlert('Failed to load configuration', 'warning');
      }
    };

    // Load current prompt
    async function loadPrompt() {
      try {
        const data = await HanuAPI.getSystemPrompt();
        sections = data.sections || getDefaultSections();
        renderSections();
        updateStats();
      } catch (error) {
        console.error('Failed to load prompt:', error);
        sections = getDefaultSections();
        renderSections();
        updateStats();
        showAlert('Failed to load prompt: ' + error.message, 'warning');
      }
    }

    // Get default sections
    function getDefaultSections() {
      return [
        {
          name: "System Role",
          content: "Báº¡n lÃ  trá»£ lÃ½ tin tá»©c cá»§a trÆ°á»ng Äáº¡i há»c HÃ  Ná»™i. Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  xá»­ lÃ½ ná»™i dung RSS feed vÃ  táº¡o tÃ³m táº¯t háº¥p dáº«n cho cÃ¡c bÃ i Ä‘Äƒng Discord."
        },
        {
          name: "Output Format", 
          content: "Äá»‹nh dáº¡ng pháº£n há»“i cá»§a báº¡n nhÆ° sau:\n\n**ğŸ“ TÃ³m táº¯t**: TÃ³m táº¯t ngáº¯n gá»n báº±ng tiáº¿ng Viá»‡t (1-2 cÃ¢u)\n**ğŸ“‹ Chi tiáº¿t**: ThÃ´ng tin chi tiáº¿t vÃ  quan trá»ng\n**ğŸ‘¥ LiÃªn quan**: ThÃ´ng tin liÃªn quan Ä‘áº¿n sinh viÃªn HANU\n**ğŸ”— Nguá»“n**: Link bÃ i viáº¿t gá»‘c"
        },
        {
          name: "Content Guidelines",
          content: "- Sá»­ dá»¥ng tiáº¿ng Viá»‡t tá»± nhiÃªn vÃ  dá»… hiá»ƒu\n- Táº­p trung vÃ o thÃ´ng tin há»¯u Ã­ch cho sinh viÃªn\n- LÃ m ná»•i báº­t cÃ¡c thÃ´ng tin quan trá»ng nhÆ° thá»i gian, Ä‘á»‹a Ä‘iá»ƒm\n- Giá»¯ tone tÃ­ch cá»±c vÃ  chuyÃªn nghiá»‡p\n- TrÃ¡nh thÃ´ng tin khÃ´ng chÃ­nh xÃ¡c hoáº·c cáº£m tÃ­nh"
        }
      ];
    }

    // Render sections
    function renderSections() {
      const container = document.getElementById('sections-container');
      
      if (sections.length === 0) {
        container.innerHTML = '<div class="loading">No sections configured</div>';
        return;
      }

      let html = '';
      sections.forEach((section, index) => {
        html += `
          <div class="prompt-section" data-index="${index}">
            <div class="prompt-header">
              <input 
                type="text" 
                value="${section.name}" 
                onchange="updateSectionName(${index}, this.value)"
                placeholder="Section name"
                class="w-full"
                style="font-weight: 600; font-size: 16px; border: none; background: transparent;"
              >
              <div>
                <button onclick="moveSection(${index}, -1)" class="btn btn-outline" ${index === 0 ? 'disabled' : ''}>â¬†ï¸</button>
                <button onclick="moveSection(${index}, 1)" class="btn btn-outline" ${index === sections.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                <button onclick="removeSection(${index})" class="btn btn-danger">ğŸ—‘ï¸</button>
              </div>
            </div>
            
            <div class="form-group">
              <textarea 
                rows="6" 
                placeholder="Enter section content (supports Markdown)"
                onchange="updateSectionContent(${index}, this.value)"
                oninput="updatePreview(${index}); updateStats()"
              >${section.content}</textarea>
            </div>
            
            <div class="prompt-preview" id="preview-${index}">
              ${marked.parse(section.content || '')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      
      // Update all previews
      sections.forEach((_, index) => updatePreview(index));
      twemoji.parse(container, { folder: 'svg', ext: '.svg' });
    }

    // Update section name
    window.updateSectionName = function(index, name) {
      if (sections[index]) {
        sections[index].name = name;
        updateStats();
      }
    };

    // Update section content
    window.updateSectionContent = function(index, content) {
      if (sections[index]) {
        sections[index].content = content;
        updateStats();
      }
    };

    // Update preview
    window.updatePreview = function(index) {
      const preview = document.getElementById(`preview-${index}`);
      const section = sections[index];
      
      if (preview && section) {
        try {
          preview.innerHTML = marked.parse(section.content || '');
          twemoji.parse(preview, { folder: 'svg', ext: '.svg' });
        } catch (error) {
          preview.innerHTML = '<em>Markdown preview error</em>';
        }
      }
    };

    // Add section
    window.addSection = function() {
      sections.push({
        name: `Section ${sections.length + 1}`,
        content: "Enter your prompt content here..."
      });
      renderSections();
      updateStats();
    };

    // Remove section
    window.removeSection = function(index) {
      if (sections.length > 1 && confirm('Remove this section?')) {
        sections.splice(index, 1);
        renderSections();
        updateStats();
      } else if (sections.length === 1) {
        showAlert('Cannot remove the last section', 'warning');
      }
    };

    // Move section
    window.moveSection = function(index, direction) {
      const newIndex = index + direction;
      if (newIndex >= 0 && newIndex < sections.length) {
        [sections[index], sections[newIndex]] = [sections[newIndex], sections[index]];
        renderSections();
        updateStats();
      }
    };

    // Save prompt
    window.savePrompt = async function() {
      const saveBtn = document.getElementById('save-btn');
      
      if (sections.length === 0) {
        showAlert('Cannot save empty prompt', 'warning');
        return;
      }

      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

      try {
        await HanuAPI.updateSystemPrompt(sections);
        lastSavedTime = new Date();
        updateStats();
        showAlert('System prompt saved successfully! ğŸ‰', 'success');
      } catch (error) {
        showAlert('Failed to save prompt: ' + error.message, 'danger');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'ğŸ’¾ Save Prompt';
      }
    };

    // Test prompt
    window.testPrompt = async function() {
      const testBtn = document.getElementById('test-btn');
      const content = document.getElementById('test-content').value.trim();
      const resultsDiv = document.getElementById('test-results');

      if (!content) {
        showAlert('Please enter test content', 'warning');
        return;
      }

      testBtn.disabled = true;
      testBtn.innerHTML = '<span class="loading-spinner"></span> Testing...';
      
      resultsDiv.innerHTML = `
        <div class="test-result">
          <h3>ğŸ§ª Testing Prompt...</h3>
          <p>Sending test content to AI with current prompt configuration...</p>
        </div>
      `;

      try {
        const response = await HanuAPI.testPrompt(content);
        
        resultsDiv.innerHTML = `
          <div class="test-result">
            <h3>ğŸ¤– AI Response</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap;">${response.result || 'No response received'}</div>
            <small style="color: #666;">Generated: ${new Date().toLocaleString()} | Test completed successfully</small>
          </div>
        `;
        
        twemoji.parse(resultsDiv, { folder: 'svg', ext: '.svg' });

      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="test-result">
            <h3>âŒ Test Failed</h3>
            <p style="color: #dc3545;">${error.message}</p>
            <small style="color: #666;">Make sure your prompt is saved and the AI service is available</small>
          </div>
        `;
      } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = 'ğŸš€ Test with AI';
      }
    };

    // Clear test
    window.clearTest = function() {
      document.getElementById('test-content').value = '';
      document.getElementById('test-results').innerHTML = '';
    };

    // Load sample content
    window.loadSampleContent = function() {
      const samples = [
        {
          title: "Sample University Event",
          content: `TiÃªu Ä‘á»: Há»™i tháº£o Khoa há»c Sinh viÃªn nÄƒm 2025
Ná»™i dung: Khoa CÃ´ng nghá»‡ ThÃ´ng tin - TrÆ°á»ng Äáº¡i há»c HÃ  Ná»™i tá»• chá»©c Há»™i tháº£o Khoa há»c Sinh viÃªn vá»›i chá»§ Ä‘á» "AI vÃ  TÆ°Æ¡ng lai". Thá»i gian: 9:00 ngÃ y 30/7/2025 táº¡i Há»™i trÆ°á»ng B1. Sinh viÃªn quan tÃ¢m Ä‘Äƒng kÃ½ táº¡i vÄƒn phÃ²ng khoa.
Link: https://www.facebook.com/khoacntt.hanu/posts/847604707367028
NgÃ y Ä‘Äƒng: 2025-07-21T10:30:00`
        },
        {
          title: "Sample Club Activity",
          content: `TiÃªu Ä‘á»: CLB Guitar HANU - Buá»•i biá»ƒu diá»…n cuá»‘i ká»³
Ná»™i dung: CLB Guitar HANU xin thÃ´ng bÃ¡o buá»•i biá»ƒu diá»…n Ã¢m nháº¡c cuá»‘i ká»³ sáº½ diá»…n ra vÃ o 19:00 thá»© 6 ngÃ y 26/7/2025 táº¡i sÃ¢n kháº¥u ngoÃ i trá»i. ChÆ°Æ¡ng trÃ¬nh cÃ³ sá»± tham gia cá»§a cÃ¡c thÃ nh viÃªn CLB vá»›i nhiá»u tiáº¿t má»¥c háº¥p dáº«n. Sinh viÃªn toÃ n trÆ°á»ng Ä‘Æ°á»£c má»i tham dá»± miá»…n phÃ­.
Link: https://www.facebook.com/Hanuguitar/posts/1140180748143664
NgÃ y Ä‘Äƒng: 2025-07-21T14:15:00`
        }
      ];
      
      const randomSample = samples[Math.floor(Math.random() * samples.length)];
      document.getElementById('test-content').value = randomSample.content;
    };

    // Load templates
    window.loadTemplate = function(templateType) {
      if (!confirm('This will replace your current prompt. Continue?')) return;

      const templates = {
        vietnamese: [
          {
            name: "System Role - Vietnamese University",
            content: "Báº¡n lÃ  trá»£ lÃ½ thÃ´ng minh chuyÃªn xá»­ lÃ½ tin tá»©c cá»§a trÆ°á»ng Äáº¡i há»c HÃ  Ná»™i. Báº¡n cÃ³ kháº£ nÄƒng Ä‘á»c hiá»ƒu vÃ  tÃ³m táº¯t ná»™i dung RSS feed tá»« cÃ¡c trang Facebook cá»§a trÆ°á»ng vÃ  cÃ¡c cÃ¢u láº¡c bá»™ sinh viÃªn."
          },
          {
            name: "Output Format - Discord Optimized",
            content: "Äá»‹nh dáº¡ng pháº£n há»“i cho Discord:\n\n**ğŸ“¢ THÃ”NG BÃO**\n**ğŸ“ TÃ³m táº¯t**: [TÃ³m táº¯t ngáº¯n gá»n 1-2 cÃ¢u]\n**ğŸ“‹ Chi tiáº¿t**: [ThÃ´ng tin chi tiáº¿t quan trá»ng]\n**ğŸ“… Thá»i gian**: [Náº¿u cÃ³ thÃ´ng tin vá» thá»i gian]\n**ğŸ“ Äá»‹a Ä‘iá»ƒm**: [Náº¿u cÃ³ thÃ´ng tin vá» Ä‘á»‹a Ä‘iá»ƒm]\n**ğŸ‘¥ Äá»‘i tÆ°á»£ng**: [Ai nÃªn quan tÃ¢m]\n**ğŸ”— Chi tiáº¿t**: [Link gá»‘c]"
          }
        ],
        general: [
          {
            name: "System Role - General RSS Bot",
            content: "You are an intelligent RSS feed processor. Your task is to analyze RSS content and create engaging summaries for social media posting."
          },
          {
            name: "Output Guidelines",
            content: "Format your response as:\n\n**Summary**: Brief overview in 1-2 sentences\n**Details**: Important information and context\n**Action**: What users should do (if applicable)\n**Source**: Original link"
          }
        ],
        minimal: [
          {
            name: "Simple Processing",
            content: "Create a brief, engaging summary of the RSS content. Keep it concise and highlight the most important information. Use appropriate emojis and format for social media."
          }
        ],
        detailed: [
          {
            name: "Comprehensive Analysis",
            content: "You are an advanced content processor with expertise in:\n1. Content analysis and summarization\n2. Audience targeting\n3. Social media optimization\n4. Information prioritization\n\nProvide detailed analysis of RSS content including context, relevance, and actionable insights."
          },
          {
            name: "Output Structure",
            content: "Provide output in the following structure:\n\n**Executive Summary**: Key points in bullet format\n**Detailed Analysis**: Comprehensive breakdown\n**Target Audience**: Who should care about this\n**Recommended Actions**: What users should do\n**Context**: Background information\n**Source Attribution**: Proper crediting"
          }
        ]
      };

      if (templates[templateType]) {
        sections = templates[templateType];
        renderSections();
        updateStats();
        showAlert(`${templateType.charAt(0).toUpperCase() + templateType.slice(1)} template loaded! ğŸ“š`, 'success');
      }
    };

    // Update statistics
    function updateStats() {
      document.getElementById('sections-count').textContent = sections.length;
      
      const totalLength = sections.reduce((sum, section) => sum + (section.content || '').length, 0);
      document.getElementById('total-length').textContent = totalLength.toLocaleString();
      
      document.getElementById('last-saved').textContent = lastSavedTime ? 
        formatDate(lastSavedTime) : 'Never';
    }

    // Format date helper
    function formatDate(date) {
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffMinutes < 1) return 'Just now';
      if (diffMinutes < 60) return `${diffMinutes}m ago`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
      return date.toLocaleDateString();
    }

    // Alert helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fade-in`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      alertDiv.textContent = message;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>
