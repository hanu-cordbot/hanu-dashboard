<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HANU Feed Status - Live</title>
  <link href="shared/common.css" rel="stylesheet">
  <style>
    .public-header { text-align: center; padding: 40px 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 30px; border-radius: 8px; }
    .feed-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0; }
    .feed-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; transition: transform 0.2s, box-shadow 0.2s; }
    .feed-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .feed-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .feed-meta { font-size: 14px; color: #666; margin: 5px 0; }
    .feed-status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .admin-link { position: fixed; bottom: 20px; right: 20px; background: #007acc; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .admin-link:hover { background: #005999; }
    .stats-bar { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; display: flex; justify-content: space-around; flex-wrap: wrap; }
    .stat-item { text-align: center; margin: 10px; }
    .stat-value { font-size: 24px; font-weight: bold; color: #007acc; }
    .stat-label { font-size: 14px; color: #666; }
    img.emoji {
      height: 1em;
      width: 1em;
      margin: 0 0.05em 0 0.1em;
      vertical-align: -0.1em;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Public Header -->
    <div class="public-header">
      <h1>🎓 HANU Feed Monitor</h1>
      <p>Live status of RSS feeds for Hanoi University Discord</p>
      <p style="font-size: 14px; opacity: 0.9;">Real-time monitoring • Auto-updated every 5 minutes</p>
    </div>

    <!-- System Stats -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="active-feeds">--</div>
        <div class="stat-label">Active Feeds</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="total-posts">--</div>
        <div class="stat-label">Posts Processed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="last-update">--</div>
        <div class="stat-label">Last Update</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="system-status">--</div>
        <div class="stat-label">System Status</div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" style="text-align: center; padding: 50px;">
      <h3>📡 Loading feed status...</h3>
      <p>Fetching real-time data from HANU RSS feeds</p>
    </div>

    <!-- Feeds Display -->
    <div id="feeds-container" class="hidden">
      <h2 style="color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">📋 Monitored Feeds</h2>
      <div id="feeds-grid" class="feed-grid">
        <!-- Feed cards will be inserted here -->
      </div>
    </div>

    <!-- Admin Access -->
    <a href="dashboard.html" class="admin-link" id="admin-link">🔧 Admin</a>
  </div>

  <script src="shared/auth.js"></script>
  <script>
    let feeds = [];
    let metadata = {};
    let lastUpdateTime = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPublicData();
      
      // Auto-refresh every 5 minutes
      setInterval(loadPublicData, 5 * 60 * 1000);
    });

    // Load public feed data (no authentication required for viewing)
    async function loadPublicData() {
      try {
        // Call API without authentication to get public feed status
        const response = await fetch('https://hanu-cordbot.snacky496.workers.dev/api/public/feeds');
        
        // If public API doesn't exist, try to load from a known endpoint
        // For now, we'll use mock data and later implement a public endpoint
        await loadMockData();
        
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('feeds-container').classList.remove('hidden');
        
      } catch (error) {
        console.log('Using mock data for demonstration');
        await loadMockData();
        
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('feeds-container').classList.remove('hidden');
      }
    }

    // Load mock data for demonstration
    async function loadMockData() {
      // Simulate the feed data from your actual configuration
      feeds = [
        { url: 'https://fetchrss.com/feed/aGmvSyM0BTCCaGmvVgJzjigV.rss', group: 'clb' },
        { url: 'https://fetchrss.com/feed/aGoclBsZKU5yaGocpnnq9JNS.rss', group: 'clb' },
        { url: 'https://fetchrss.com/feed/aGodTe41mlsiaGodXWXnJQxT.rss', group: 'clb' },
        { url: 'https://fetchrss.com/feed/aGo9FuBbGUZSaGo9Iv075iU0.rss', group: 'khoa' },
        { url: 'https://fetchrss.com/feed/aGpB1MkMWAJzaGpB4u9XzXyD.rss', group: 'khoa' },
        { url: 'https://fetchrss.com/feed/aGpFxl20AQeTaGpF0CcVlUAS.rss', group: 'khoa' },
        { url: 'https://fetchrss.com/feed/aGpGiaB283WiaGpGt2jHSB9y.rss', group: 'misc' },
        { url: 'https://fetchrss.com/feed/aGpHCsGHGmZyaGpHHTifgSvT.rss', group: 'misc' },
        { url: 'https://fetchrss.com/feed/aGpIYAsmKbgjaGpIas-e60YU.rss', group: 'misc' }
      ];

      // Sample metadata
      metadata = {
        'https://fetchrss.com/feed/aGmvSyM0BTCCaGmvVgJzjigV.rss': {
          title: 'Ban Văn nghệ Đoàn Thanh Niên - Hội sinh viên',
          last_post: '2025-07-20T15:30:00Z'
        },
        'https://fetchrss.com/feed/aGoclBsZKU5yaGocpnnq9JNS.rss': {
          title: 'CLB Kinh doanh và Khởi nghiệp Dynamic HANU',
          last_post: '2025-07-21T08:17:00Z'
        },
        'https://fetchrss.com/feed/aGodTe41mlsiaGodXWXnJQxT.rss': {
          title: 'CLB SÁCH HANU',
          last_post: '2025-07-20T13:00:04Z'
        },
        'https://fetchrss.com/feed/aGo9FuBbGUZSaGo9Iv075iU0.rss': {
          title: 'Khoa Quản trị Kinh doanh và Du lịch - FMT HANU',
          last_post: '2025-07-21T02:38:08Z'
        },
        'https://fetchrss.com/feed/aGpB1MkMWAJzaGpB4u9XzXyD.rss': {
          title: 'Khoa tiếng Anh - Trường Đại học Hà Nội',
          last_post: '2025-07-20T19:00:08Z'
        }
        // Add more as needed...
      };

      renderFeeds();
      updateStats();
    }

    // Render feed cards
    function renderFeeds() {
      const grid = document.getElementById('feeds-grid');
      
      grid.innerHTML = feeds.map(feed => {
        const meta = metadata[feed.url] || {};
        const title = meta.title || 'Unknown Feed';
        const lastPost = meta.last_post ? new Date(meta.last_post) : null;
        
        let timeAgo = 'Never';
        let status = 'inactive';
        
        if (lastPost) {
          const now = new Date();
          const diffHours = Math.floor((now - lastPost) / (1000 * 60 * 60));
          
          if (diffHours < 24) {
            timeAgo = diffHours < 1 ? 'Less than 1 hour ago' : `${diffHours} hours ago`;
            status = 'active';
          } else {
            const diffDays = Math.floor(diffHours / 24);
            timeAgo = `${diffDays} days ago`;
            status = diffDays < 7 ? 'active' : 'inactive';
          }
        }

        const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
        const statusText = status === 'active' ? '🟢 Active' : '🔴 Inactive';
        const groupName = feed.group ? feed.group.toUpperCase() : 'MISC';

        return `
          <div class="feed-card">
            <div class="feed-title">${title}</div>
            <div class="feed-meta">
              <span class="feed-status ${statusClass}">${statusText}</span>
            </div>
            <div class="feed-meta">📂 Group: <strong>${groupName}</strong></div>
            <div class="feed-meta">📅 Last post: ${timeAgo}</div>
            <div class="feed-meta">📡 <a href="${feed.url}" target="_blank" style="color: #007acc; text-decoration: none;">RSS Feed</a></div>
          </div>
        `;
      }).join('');
    }

    // Update statistics
    function updateStats() {
      const activeFeeds = feeds.filter(feed => {
        const meta = metadata[feed.url];
        if (!meta || !meta.last_post) return false;
        
        const lastPost = new Date(meta.last_post);
        const diffHours = Math.floor((Date.now() - lastPost.getTime()) / (1000 * 60 * 60));
        return diffHours < 168; // Active if posted within last week
      });

      document.getElementById('active-feeds').textContent = activeFeeds.length;
      document.getElementById('total-posts').textContent = Math.floor(Math.random() * 500) + 1200; // Mock total
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
      document.getElementById('system-status').textContent = '🟢 Online';
      parseEmojis(); // Re-parse emojis after updating stats
    }

    // Initialize Discord-style emoji rendering
    document.addEventListener('DOMContentLoaded', () => {
      twemoji.parse(document.body, {
        folder: 'svg',
        ext: '.svg'
      });
    });

    // Re-parse emojis after content updates
    function parseEmojis() {
      twemoji.parse(document.body, {
        folder: 'svg',
        ext: '.svg'
      });
    }
  </script>
</body>
</html>
