<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HANU Feed Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <style>
    /* Discord emoji styling */
    img.emoji { height: 1em; width: 1em; margin: 0 0.05em 0 0.1em; vertical-align: -0.1em; }
    
    /* Minimal design matching your old layout */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; color: #333; line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    /* Simple header - no gradients */
    .header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
    .header h1 { margin: 0; font-size: 1.8rem; color: #495057; font-weight: 600; }
    .header p { margin: 5px 0 0 0; color: #6c757d; font-size: 0.95rem; }
    
    /* Stats bar - minimal */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 6px; }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: #495057; }
    .stat-label { font-size: 0.85rem; color: #6c757d; margin-top: 4px; }
    
    /* Simple controls */
    .controls { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; }
    .controls label { font-weight: 500; margin-right: 15px; }
    .controls a { color: #007bff; text-decoration: none; margin: 0 8px; }
    .controls a:hover { text-decoration: underline; }
    .controls a.active { font-weight: 600; color: #495057; }
    
    /* Table layout - matching your old design */
    .feeds-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .feeds-table th, .feeds-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
    .feeds-table th { background: #f8f9fa; font-weight: 600; color: #495057; font-size: 0.9rem; }
    .feeds-table tbody tr:hover { background: #f8f9fa; }
    
    /* Feed row styling */
    .feed-name { font-weight: 500; color: #495057; }
    .feed-date { color: #6c757d; font-size: 0.9rem; }
    .feed-channel { color: #6c757d; font-size: 0.9rem; }
    .feed-link { color: #007bff; text-decoration: none; font-size: 0.9rem; }
    .feed-link:hover { text-decoration: underline; }
    
    /* Status indicators */
    .status { padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    
    /* Admin link */
    .admin-link { position: fixed; bottom: 20px; right: 20px; background: #007bff; color: white; padding: 10px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .admin-link:hover { background: #0056b3; }
    
    /* Loading/error states */
    .loading, .error { text-align: center; padding: 40px; color: #6c757d; }
    .error { color: #dc3545; }
    
    /* Responsive */
    @media (max-width: 768px) { 
      .stats { grid-template-columns: repeat(2, 1fr); } 
      .feeds-table { font-size: 0.9rem; }
      .feeds-table th, .feeds-table td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Simple header -->
    <div class="header">
      <h1>üìã HANU Feed Monitor</h1>
      <p>Real-time status monitoring for Hanoi University RSS feeds</p>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="active-feeds">--</div>
        <div class="stat-label">Active Feeds</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="total-feeds">--</div>
        <div class="stat-label">Total Monitored</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="last-update">--</div>
        <div class="stat-label">Last Update</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="system-status">--</div>
        <div class="stat-label">System Status</div>
      </div>
    </div>

    <!-- Controls (matching your old design) -->
    <div class="controls">
      <label>View:</label>
      <a href="#" onclick="setView('flat')" class="active" id="flat-link">Flat</a> |
      <a href="#" onclick="setView('grouped')" id="grouped-link">Grouped</a>
      
      <label style="margin-left: 30px;">Group by:</label>
      <a href="#" onclick="setGroup('none')" class="active" id="group-none">None</a> |
      <a href="#" onclick="setGroup('category')" id="group-category">Category</a> |
      <a href="#" onclick="setGroup('channel')" id="group-channel">Channel</a>
      
      <label style="margin-left: 30px;">Sort by:</label>
      <a href="#" onclick="setSort('name')" class="active" id="sort-name">Name</a> |
      <a href="#" onclick="setSort('url')" id="sort-url">URL</a> |
      <a href="#" onclick="setSort('newest')" id="sort-newest">Newest</a> |
      <a href="#" onclick="setSort('oldest')" id="sort-oldest">Oldest</a>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading">
      üì° Loading feed data...
    </div>

    <!-- Error state -->
    <div id="error-state" class="error" style="display: none;">
      ‚ö†Ô∏è Unable to load feed data. <button onclick="loadData()">Retry</button>
    </div>

    <!-- Feeds table (matching your old design) -->
    <table class="feeds-table" id="feeds-table" style="display: none;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Date</th>
          <th>Channel</th>
          <th>Page</th>
        </tr>
      </thead>
      <tbody id="feeds-tbody">
        <!-- Table rows will be inserted here -->
      </tbody>
    </table>

    <!-- Admin link -->
    <a href="dashboard.html" class="admin-link">üîß Admin</a>
  </div>

  <script>
    let feeds = [];
    let metadata = {};
    let groups = {};
    let currentView = 'flat';
    let currentGroup = 'none';
    let currentSort = 'name';

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('error-state').style.display = 'none';
      document.getElementById('feeds-table').style.display = 'none';

      try {
        const response = await fetch('https://hanu-cordbot.snacky496.workers.dev/api/public/feeds');
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        feeds = data.feeds || [];
        metadata = data.metadata || {};
        groups = data.groups || {};
        
        renderTable();
        updateStats();
        
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('feeds-table').style.display = 'table';
        
      } catch (error) {
        console.error('Failed to load data:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
      }
    }

    function renderTable() {
      const tbody = document.getElementById('feeds-tbody');
      
      if (feeds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6c757d;">No feeds available</td></tr>';
        return;
      }

      // Sort feeds
      let sortedFeeds = [...feeds];
      switch (currentSort) {
        case 'name':
          sortedFeeds.sort((a, b) => (metadata[a.url]?.title || a.url).localeCompare(metadata[b.url]?.title || b.url));
          break;
        case 'newest':
          sortedFeeds.sort((a, b) => new Date(metadata[b.url]?.last_post || 0) - new Date(metadata[a.url]?.last_post || 0));
          break;
        case 'oldest':
          sortedFeeds.sort((a, b) => new Date(metadata[a.url]?.last_post || 0) - new Date(metadata[b.url]?.last_post || 0));
          break;
      }

      tbody.innerHTML = sortedFeeds.map(feed => {
        const meta = metadata[feed.url] || {};
        const title = meta.title || feed.title || 'Unknown Feed';
        const lastPost = meta.last_post ? formatDate(new Date(meta.last_post)) : 'Never';
        const pageUrl = meta.page_url || feed.pageUrl || feed.url;
        const isActive = meta.last_post && (Date.now() - new Date(meta.last_post)) < 7 * 24 * 60 * 60 * 1000;
        
        return `
          <tr>
            <td>
              <div class="feed-name">${title}</div>
              <span class="status ${isActive ? 'status-active' : 'status-inactive'}">
                ${isActive ? 'üü¢ Active' : 'üî¥ Inactive'}
              </span>
            </td>
            <td class="feed-date">${lastPost}</td>
            <td class="feed-channel">Not mapped</td>
            <td><a href="${pageUrl}" target="_blank" class="feed-link">üîó Page</a></td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      const activeFeeds = feeds.filter(feed => {
        const meta = metadata[feed.url];
        return meta?.last_post && (Date.now() - new Date(meta.last_post)) < 7 * 24 * 60 * 60 * 1000;
      });

      document.getElementById('active-feeds').textContent = activeFeeds.length;
      document.getElementById('total-feeds').textContent = feeds.length;
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
      document.getElementById('system-status').textContent = feeds.length > 0 ? 'üü¢ Online' : 'üî¥ Offline';
    }

    function formatDate(date) {
      const now = new Date();
      const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
      
      if (diffHours < 24) {
        return diffHours < 1 ? 'Just now' : `${diffHours}h ago`;
      } else {
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
      }
    }

    // Control functions
    function setView(view) {
      currentView = view;
      document.getElementById('flat-link').classList.toggle('active', view === 'flat');
      document.getElementById('grouped-link').classList.toggle('active', view === 'grouped');
      renderTable();
    }

    function setGroup(group) {
      currentGroup = group;
      document.getElementById('group-none').classList.toggle('active', group === 'none');
      document.getElementById('group-category').classList.toggle('active', group === 'category');
      document.getElementById('group-channel').classList.toggle('active', group === 'channel');
      renderTable();
    }

    function setSort(sort) {
      currentSort = sort;
      document.getElementById('sort-name').classList.toggle('active', sort === 'name');
      document.getElementById('sort-url').classList.toggle('active', sort === 'url');
      document.getElementById('sort-newest').classList.toggle('active', sort === 'newest');
      document.getElementById('sort-oldest').classList.toggle('active', sort === 'oldest');
      renderTable();
    }

    // Parse emojis
    document.addEventListener('DOMContentLoaded', () => {
      twemoji.parse(document.body, { folder: 'svg', ext: '.svg' });
    });
  </script>
</body>
</html>
